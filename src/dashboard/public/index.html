<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü§ñ Bot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a26;
      --bg-hover: #22222f;
      --accent: #6c5ce7;
      --accent-glow: rgba(108, 92, 231, 0.3);
      --accent-light: #a29bfe;
      --green: #00d2a0;
      --red: #ff6b6b;
      --yellow: #ffd93d;
      --text-primary: #e8e8ed;
      --text-secondary: #8888a0;
      --border: rgba(255,255,255,0.06);
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ‚îÄ */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: radial-gradient(ellipse at 50% 0%, rgba(108,92,231,0.15) 0%, transparent 60%);
    }

    .login-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 48px;
      width: 380px;
      text-align: center;
    }

    .login-box h1 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
    .login-box p { color: var(--text-secondary); margin-bottom: 32px; }

    .input-group {
      position: relative;
      margin-bottom: 16px;
    }

    .input-group input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-family: inherit;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-danger { background: var(--red); color: white; }
    .btn-danger:hover { opacity: 0.9; }

    .error-msg {
      color: var(--red);
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }

    /* ‚îÄ‚îÄ‚îÄ App Layout ‚îÄ‚îÄ‚îÄ */
    #app { display: none; }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 240px;
      height: 100vh;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 8px;
      margin-bottom: 32px;
    }

    .sidebar-brand img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .sidebar-brand .brand-name {
      font-weight: 700;
      font-size: 15px;
    }

    .sidebar-brand .brand-status {
      font-size: 11px;
      color: var(--green);
    }

    .nav-section {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0 8px;
      margin: 20px 0 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.15s;
    }

    .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .main {
      margin-left: 240px;
      padding: 32px;
      min-height: 100vh;
      background: radial-gradient(ellipse at 80% 0%, rgba(108,92,231,0.06) 0%, transparent 50%);
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-header h2 {
      font-size: 24px;
      font-weight: 800;
    }

    .page-header p {
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ‚îÄ Stats Cards ‚îÄ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all 0.2s;
    }

    .stat-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    .stat-card .stat-icon { font-size: 28px; margin-bottom: 12px; }
    .stat-card .stat-value { font-size: 28px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
    .stat-card .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

    /* ‚îÄ‚îÄ‚îÄ Cards / Panels ‚îÄ‚îÄ‚îÄ */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
    }

    .card h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 12px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover td { background: var(--bg-hover); }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-green { background: rgba(0,210,160,0.15); color: var(--green); }
    .badge-red { background: rgba(255,107,107,0.15); color: var(--red); }
    .badge-yellow { background: rgba(255,217,61,0.15); color: var(--yellow); }

    /* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    /* ‚îÄ‚îÄ‚îÄ Channel tree ‚îÄ‚îÄ‚îÄ */
    .channel-tree { padding: 0; }
    .channel-category {
      margin-bottom: 12px;
    }
    .channel-category-name {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .channel-item {
      padding: 6px 8px 6px 24px;
      font-size: 14px;
      color: var(--text-secondary);
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .channel-item:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* ‚îÄ‚îÄ‚îÄ Page visibility ‚îÄ‚îÄ‚îÄ */
    .page { display: none; }
    .page.active { display: block; }

    /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      background: var(--bg-card);
      border: 1px solid var(--green);
      border-radius: 10px;
      font-size: 14px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .sidebar { width: 60px; padding: 16px 8px; }
      .sidebar .brand-name, .sidebar .brand-status, .sidebar .nav-section, .sidebar .nav-item span:not(.icon) { display: none; }
      .main { margin-left: 60px; padding: 16px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-box">
      <h1>ü§ñ Bot Panel</h1>
      <p>Inicia sesi√≥n con tu cuenta de Discord</p>
      <div class="error-msg" id="login-error"></div>
      <a href="/api/auth/discord" class="btn btn-primary" style="margin-top:12px;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;width:100%">
        <svg width="20" height="15" viewBox="0 0 71 55" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M60.1 4.9A58.5 58.5 0 0 0 45.4.2a.2.2 0 0 0-.2.1 40.8 40.8 0 0 0-1.8 3.7 54 54 0 0 0-16.2 0A37.4 37.4 0 0 0 25.4.3a.2.2 0 0 0-.2-.1A58.4 58.4 0 0 0 10.5 5a.2.2 0 0 0-.1 0C1.5 18 -.9 30.6.3 43a.2.2 0 0 0 .1.2 58.7 58.7 0 0 0 17.7 9 .2.2 0 0 0 .3-.1 42 42 0 0 0 3.6-5.9.2.2 0 0 0-.1-.3 38.7 38.7 0 0 1-5.5-2.6.2.2 0 0 1 0-.4l1.1-.9a.2.2 0 0 1 .2 0 41.9 41.9 0 0 0 35.6 0 .2.2 0 0 1 .2 0l1.1.9a.2.2 0 0 1 0 .3c-1.8 1-3.6 1.8-5.5 2.7a.2.2 0 0 0-.1.3 47.2 47.2 0 0 0 3.6 5.8.2.2 0 0 0 .3.1A58.5 58.5 0 0 0 70.2 43a.2.2 0 0 0 .1-.2c1.4-14.7-2.4-27.4-10.1-38.7a.2.2 0 0 0-.1-.1zM23.7 35.3c-3.4 0-6.1-3.1-6.1-6.9s2.7-6.9 6.1-6.9 6.2 3.1 6.1 6.9c0 3.8-2.7 6.9-6.1 6.9zm22.6 0c-3.4 0-6.1-3.1-6.1-6.9s2.7-6.9 6.1-6.9 6.2 3.1 6.1 6.9c0 3.8-2.7 6.9-6.1 6.9z"/></svg>
        Iniciar sesi√≥n con Discord
      </a>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-brand">
        <img id="bot-avatar" src="" alt="Bot">
        <div>
          <div class="brand-name" id="bot-name">Bot</div>
          <div class="brand-status">‚óè Online</div>
        </div>
      </div>

      <div class="nav-section">Principal</div>
      <div class="nav-item active" data-page="overview" onclick="showPage('overview')">
        <span class="icon">üìä</span><span>Overview</span>
      </div>
      <div class="nav-item" data-page="servers" onclick="showPage('servers')">
        <span class="icon">üè†</span><span>Servidores</span>
      </div>

      <div class="nav-section">Gesti√≥n</div>
      <div class="nav-item" data-page="announcements" onclick="showPage('announcements')">
        <span class="icon">üì¢</span><span>Anuncios</span>
      </div>
      <div class="nav-item" data-page="messages" onclick="showPage('messages')">
        <span class="icon">üí¨</span><span>Enviar Mensaje</span>
      </div>
      <div class="nav-item" data-page="warnings-page" onclick="showPage('warnings-page')">
        <span class="icon">‚ö†Ô∏è</span><span>Advertencias</span>
      </div>

      <div class="sidebar-footer">
        <div class="nav-item" onclick="logout()">
          <span class="icon">üö™</span><span>Cerrar sesi√≥n</span>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main">

      <!-- OVERVIEW PAGE -->
      <div class="page active" id="page-overview">
        <div class="page-header">
          <h2>Dashboard</h2>
          <p>Vista general del bot</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üè†</div>
            <div class="stat-value" id="stat-guilds">-</div>
            <div class="stat-label">Servidores</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-value" id="stat-members">-</div>
            <div class="stat-label">Miembros totales</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üí¨</div>
            <div class="stat-value" id="stat-channels">-</div>
            <div class="stat-label">Canales</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üì°</div>
            <div class="stat-value" id="stat-ping">-</div>
            <div class="stat-label">Latencia (ms)</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value" id="stat-uptime">-</div>
            <div class="stat-label">Uptime</div>
          </div>
        </div>

        <div class="card">
          <h3>üìÖ Anuncios Programados</h3>
          <table>
            <thead><tr><th>ID</th><th>T√≠tulo</th><th>Frecuencia</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="overview-announcements"></tbody>
          </table>
        </div>
      </div>

      <!-- SERVERS PAGE -->
      <div class="page" id="page-servers">
        <div class="page-header">
          <h2>Servidores</h2>
          <p>Servidores donde est√° el bot</p>
        </div>
        <div class="stats-grid" id="guilds-list"></div>
        <div class="card" id="guild-detail" style="display:none">
          <h3 id="guild-detail-name">Servidor</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div>
              <h4 style="margin-bottom:8px;color:var(--text-secondary)">Canales</h4>
              <div id="guild-channels" class="channel-tree"></div>
            </div>
            <div>
              <h4 style="margin-bottom:8px;color:var(--text-secondary)">Roles</h4>
              <div id="guild-roles"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ANNOUNCEMENTS PAGE -->
      <div class="page" id="page-announcements">
        <div class="page-header">
          <h2>Anuncios Programados</h2>
          <p>Crea y gestiona anuncios autom√°ticos</p>
        </div>

        <div class="card">
          <h3>‚ûï Nuevo Anuncio Programado</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Canal ID</label>
              <input type="text" id="ann-channel" placeholder="ID del canal">
            </div>
            <div class="form-group">
              <label>Frecuencia</label>
              <select id="ann-cron">
                <option value="0 * * * *">Cada hora</option>
                <option value="0 */6 * * *">Cada 6 horas</option>
                <option value="0 8 * * *">Diario (8 AM)</option>
                <option value="0 12 * * *">Diario (12 PM)</option>
                <option value="0 20 * * *">Diario (8 PM)</option>
                <option value="0 9 * * 1-5">Lun-Vie (9 AM)</option>
                <option value="0 9 * * 1">Semanal (Lunes)</option>
                <option value="0 9 1 * *">Mensual (d√≠a 1)</option>
              </select>
            </div>
            <div class="form-group">
              <label>T√≠tulo</label>
              <input type="text" id="ann-title" placeholder="T√≠tulo del anuncio">
            </div>
            <div class="form-group">
              <label>Color</label>
              <input type="color" id="ann-color" value="#6c5ce7">
            </div>
          </div>
          <div class="form-group">
            <label>Mensaje</label>
            <textarea id="ann-message" placeholder="Contenido del anuncio..."></textarea>
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" onclick="createAnnouncement()">Crear Anuncio</button>
          </div>
        </div>

        <div class="card">
          <h3>üìã Anuncios Activos</h3>
          <table>
            <thead><tr><th>ID</th><th>T√≠tulo</th><th>Canal</th><th>Frecuencia</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="announcements-table"></tbody>
          </table>
        </div>
      </div>

      <!-- MESSAGES PAGE -->
      <div class="page" id="page-messages">
        <div class="page-header">
          <h2>Enviar Mensaje</h2>
          <p>Env√≠a un mensaje como el bot a cualquier canal</p>
        </div>

        <div class="card">
          <h3>üí¨ Nuevo Mensaje</h3>
          <div class="form-group">
            <label>Canal ID</label>
            <input type="text" id="msg-channel" placeholder="ID del canal">
          </div>
          <div class="form-group">
            <label>Contenido (texto plano)</label>
            <textarea id="msg-content" placeholder="Mensaje de texto..."></textarea>
          </div>

          <h4 style="margin:16px 0 12px;font-size:14px;color:var(--text-secondary)">O enviar como Embed:</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>T√≠tulo del embed</label>
              <input type="text" id="msg-embed-title" placeholder="T√≠tulo">
            </div>
            <div class="form-group">
              <label>Color</label>
              <input type="color" id="msg-embed-color" value="#6c5ce7">
            </div>
          </div>
          <div class="form-group">
            <label>Descripci√≥n del embed</label>
            <textarea id="msg-embed-desc" placeholder="Contenido del embed..."></textarea>
          </div>
          <div class="form-group">
            <label>Footer</label>
            <input type="text" id="msg-embed-footer" placeholder="Texto del footer">
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
          </div>
        </div>
      </div>

      <!-- WARNINGS PAGE -->
      <div class="page" id="page-warnings-page">
        <div class="page-header">
          <h2>Advertencias</h2>
          <p>Historial de advertencias de moderaci√≥n</p>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Usuario</th><th>Raz√≥n</th><th>Moderador</th><th>Fecha</th></tr></thead>
            <tbody id="warnings-table"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API = '';

    // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
    async function checkAuth() {
      // Check for OAuth2 error in URL
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      if (error) {
        const el = document.getElementById('login-error');
        const msgs = {
          unauthorized: 'Tu cuenta de Discord no tiene acceso a este panel.',
          token_failed: 'Error al autenticar con Discord. Intenta de nuevo.',
          no_code: 'Error en el proceso de login. Intenta de nuevo.',
          server_error: 'Error del servidor. Intenta de nuevo.',
        };
        el.textContent = msgs[error] || 'Error desconocido';
        el.style.display = 'block';
        window.history.replaceState({}, '', '/');
      }

      try {
        const res = await fetch(`${API}/api/auth-check`);
        const data = await res.json();
        if (data.authenticated) {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          if (data.user) {
            window._discordUser = data.user;
          }
          loadDashboard();
        }
      } catch {}
    }

    async function logout() {
      await fetch(`${API}/api/logout`, { method: 'POST' });
      location.reload();
    }

    // ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');
      document.querySelector(`[data-page="${page}"]`).classList.add('active');

      if (page === 'servers') loadGuilds();
      if (page === 'announcements') loadAnnouncements();
      if (page === 'warnings-page') loadWarnings();
    }

    // ‚îÄ‚îÄ‚îÄ Load Dashboard ‚îÄ‚îÄ‚îÄ
    async function loadDashboard() {
      try {
        const res = await fetch(`${API}/api/stats`);
        const stats = await res.json();

        document.getElementById('bot-name').textContent = stats.botName || 'Bot';
        document.getElementById('bot-avatar').src = stats.botAvatar || '';
        document.getElementById('stat-guilds').textContent = stats.guilds || 0;
        document.getElementById('stat-members').textContent = (stats.members || 0).toLocaleString();
        document.getElementById('stat-channels').textContent = stats.channels || 0;
        document.getElementById('stat-ping').textContent = stats.ping || '-';

        const uptime = stats.uptime || 0;
        const h = Math.floor(uptime / 3600);
        const m = Math.floor((uptime % 3600) / 60);
        document.getElementById('stat-uptime').textContent = `${h}h ${m}m`;

        loadAnnouncementsOverview();
      } catch (err) {
        console.error('Error loading dashboard:', err);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Guilds ‚îÄ‚îÄ‚îÄ
    async function loadGuilds() {
      const res = await fetch(`${API}/api/guilds`);
      const guilds = await res.json();
      const container = document.getElementById('guilds-list');
      container.innerHTML = guilds.map(g => `
        <div class="stat-card" style="cursor:pointer" onclick="loadGuildDetail('${g.id}')">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            ${g.icon ? `<img src="${g.icon}" style="width:40px;height:40px;border-radius:50%">` : '<div style="width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:18px">üè†</div>'}
            <div class="stat-value" style="font-size:16px">${g.name}</div>
          </div>
          <div style="display:flex;gap:16px;font-size:13px;color:var(--text-secondary)">
            <span>üë• ${g.members}</span>
            <span>üí¨ ${g.channels}</span>
          </div>
        </div>
      `).join('');
    }

    async function loadGuildDetail(id) {
      const res = await fetch(`${API}/api/guilds/${id}`);
      const guild = await res.json();
      document.getElementById('guild-detail').style.display = 'block';
      document.getElementById('guild-detail-name').textContent = `üìã ${guild.name}`;

      // Group channels by parent
      const categories = {};
      const orphans = [];
      guild.channels.forEach(c => {
        if (c.type === 4) { // Category
          if (!categories[c.id]) categories[c.id] = { name: c.name, channels: [] };
        }
      });
      guild.channels.forEach(c => {
        if (c.type !== 4) {
          if (c.parent && categories[c.parent]) categories[c.parent].channels.push(c);
          else orphans.push(c);
        }
      });

      const typeIcons = { 0: '#', 2: 'üîä', 5: 'üì¢', 15: 'üí¨' };
      let channelHtml = '';
      for (const [, cat] of Object.entries(categories)) {
        channelHtml += `<div class="channel-category"><div class="channel-category-name">üìÅ ${cat.name}</div>`;
        cat.channels.forEach(c => {
          channelHtml += `<div class="channel-item">${typeIcons[c.type] || '#'} ${c.name}</div>`;
        });
        channelHtml += '</div>';
      }
      document.getElementById('guild-channels').innerHTML = channelHtml;

      document.getElementById('guild-roles').innerHTML = guild.roles
        .filter(r => r.name !== '@everyone')
        .map(r => `<div style="padding:4px 0;font-size:14px"><span style="color:${r.color};font-weight:600">‚óè ${r.name}</span> <span style="color:var(--text-secondary);font-size:12px">(${r.members})</span></div>`)
        .join('');
    }

    // ‚îÄ‚îÄ‚îÄ Announcements ‚îÄ‚îÄ‚îÄ
    async function loadAnnouncements() {
      const res = await fetch(`${API}/api/announcements`);
      const data = await res.json();
      renderAnnouncementsTable(data, 'announcements-table');
    }

    async function loadAnnouncementsOverview() {
      const res = await fetch(`${API}/api/announcements`);
      const data = await res.json();
      renderAnnouncementsTable(data, 'overview-announcements');
    }

    function renderAnnouncementsTable(data, tableId) {
      const tbody = document.getElementById(tableId);
      const entries = Object.entries(data);
      if (!entries.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary)">No hay anuncios programados</td></tr>';
        return;
      }
      tbody.innerHTML = entries.map(([id, a]) => `
        <tr>
          <td><code style="color:var(--accent-light)">${id}</code></td>
          <td>${a.title || '-'}</td>
          <td>${a.channelId ? `<code>${a.channelId.slice(-6)}</code>` : '-'}</td>
          <td><code style="font-size:12px">${a.cron || '-'}</code></td>
          <td><span class="badge ${a.active ? 'badge-green' : 'badge-red'}">${a.active ? 'Activo' : 'Pausado'}</span></td>
          <td><button class="btn btn-danger" style="padding:4px 12px;font-size:12px" onclick="deleteAnnouncement('${id}')">üóëÔ∏è</button></td>
        </tr>
      `).join('');
    }

    async function createAnnouncement() {
      const body = {
        channelId: document.getElementById('ann-channel').value,
        title: document.getElementById('ann-title').value,
        message: document.getElementById('ann-message').value,
        cron: document.getElementById('ann-cron').value,
        color: document.getElementById('ann-color').value,
        active: true,
      };

      if (!body.channelId || !body.message) return toast('Completa canal y mensaje', true);

      const res = await fetch(`${API}/api/announcements`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (res.ok) {
        toast('‚úÖ Anuncio creado');
        loadAnnouncements();
        document.getElementById('ann-title').value = '';
        document.getElementById('ann-message').value = '';
      }
    }

    async function deleteAnnouncement(id) {
      if (!confirm('¬øEliminar este anuncio?')) return;
      await fetch(`${API}/api/announcements/${id}`, { method: 'DELETE' });
      toast('üóëÔ∏è Anuncio eliminado');
      loadAnnouncements();
      loadAnnouncementsOverview();
    }

    // ‚îÄ‚îÄ‚îÄ Send Message ‚îÄ‚îÄ‚îÄ
    async function sendMessage() {
      const channelId = document.getElementById('msg-channel').value;
      const content = document.getElementById('msg-content').value;
      const embedTitle = document.getElementById('msg-embed-title').value;
      const embedDesc = document.getElementById('msg-embed-desc').value;
      const embedColor = document.getElementById('msg-embed-color').value;
      const embedFooter = document.getElementById('msg-embed-footer').value;

      if (!channelId) return toast('Ingresa el ID del canal', true);
      if (!content && !embedDesc) return toast('Escribe un mensaje o embed', true);

      const body = { channelId };
      if (content) body.content = content;
      if (embedTitle || embedDesc) {
        body.embed = {};
        if (embedTitle) body.embed.title = embedTitle;
        if (embedDesc) body.embed.description = embedDesc;
        if (embedColor) body.embed.color = embedColor;
        if (embedFooter) body.embed.footer = embedFooter;
      }

      const res = await fetch(`${API}/api/send-message`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (res.ok) {
        toast('‚úÖ Mensaje enviado');
        document.getElementById('msg-content').value = '';
        document.getElementById('msg-embed-title').value = '';
        document.getElementById('msg-embed-desc').value = '';
      } else {
        const err = await res.json();
        toast(`‚ùå ${err.error}`, true);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Warnings ‚îÄ‚îÄ‚îÄ
    async function loadWarnings() {
      const res = await fetch(`${API}/api/warnings`);
      const data = await res.json();
      const tbody = document.getElementById('warnings-table');

      const rows = [];
      for (const [key, list] of Object.entries(data)) {
        const userId = key.split('-')[1] || key;
        for (const w of list) {
          rows.push(`<tr>
            <td><code>${userId.slice(-6)}</code></td>
            <td>${w.reason}</td>
            <td>${w.mod || '-'}</td>
            <td>${w.date ? new Date(w.date).toLocaleDateString() : '-'}</td>
          </tr>`);
        }
      }

      tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">Sin advertencias</td></tr>';
    }

    // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ
    function toast(msg, isError) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      if (isError) el.style.borderColor = 'var(--red)';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // ‚îÄ‚îÄ‚îÄ Auto-refresh ‚îÄ‚îÄ‚îÄ
    setInterval(() => {
      if (document.getElementById('app').style.display !== 'none') loadDashboard();
    }, 30000);

    // Init
    checkAuth();
  </script>
</body>
</html>
