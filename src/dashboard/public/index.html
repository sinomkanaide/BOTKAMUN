<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü§ñ Bot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a26;
      --bg-hover: #22222f;
      --accent: #6c5ce7;
      --accent-glow: rgba(108, 92, 231, 0.3);
      --accent-light: #a29bfe;
      --green: #00d2a0;
      --red: #ff6b6b;
      --yellow: #ffd93d;
      --text-primary: #e8e8ed;
      --text-secondary: #8888a0;
      --border: rgba(255,255,255,0.06);
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ‚îÄ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ‚îÄ */
    #login-screen {
      display: flex; align-items: center; justify-content: center; min-height: 100vh;
      background: radial-gradient(ellipse at 50% 0%, rgba(108,92,231,0.15) 0%, transparent 60%);
    }
    .login-box {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px;
      padding: 48px; width: 380px; text-align: center;
    }
    .login-box h1 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
    .login-box p { color: var(--text-secondary); margin-bottom: 32px; }
    .error-msg { color: var(--red); font-size: 13px; margin-top: 8px; display: none; }

    /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
    .btn {
      padding: 12px 24px; border-radius: 10px; border: none; font-family: inherit;
      font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: white; width: 100%; }
    .btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 4px 20px var(--accent-glow); }
    .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-danger { background: var(--red); color: white; }
    .btn-danger:hover { opacity: 0.9; }
    .btn-sm { padding: 6px 14px; font-size: 12px; }

    /* ‚îÄ‚îÄ‚îÄ App Layout ‚îÄ‚îÄ‚îÄ */
    #app { display: none; }
    .sidebar {
      position: fixed; left: 0; top: 0; width: 250px; height: 100vh;
      background: var(--bg-secondary); border-right: 1px solid var(--border);
      padding: 20px 14px; display: flex; flex-direction: column; z-index: 100;
      overflow-y: auto;
    }
    .sidebar-brand { display: flex; align-items: center; gap: 12px; padding: 0 8px; margin-bottom: 20px; }
    .sidebar-brand img { width: 40px; height: 40px; border-radius: 50%; }
    .sidebar-brand .brand-name { font-weight: 700; font-size: 15px; }
    .sidebar-brand .brand-status { font-size: 11px; color: var(--green); }

    /* Server selector */
    .server-selector { margin-bottom: 20px; padding: 0 4px; }
    .server-selector label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 6px; padding: 0 4px; }
    .server-selector select {
      width: 100%; padding: 9px 12px; background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 13px; cursor: pointer;
    }
    .server-selector select:focus { outline: none; border-color: var(--accent); }

    .nav-section { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; padding: 0 8px; margin: 16px 0 6px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 9px 12px; border-radius: 8px;
      cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-secondary); transition: all 0.15s;
    }
    .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
    .sidebar-footer { margin-top: auto; padding-top: 12px; border-top: 1px solid var(--border); }

    .main {
      margin-left: 250px; padding: 32px; min-height: 100vh;
      background: radial-gradient(ellipse at 80% 0%, rgba(108,92,231,0.06) 0%, transparent 50%);
    }
    .page-header { margin-bottom: 28px; }
    .page-header h2 { font-size: 24px; font-weight: 800; }
    .page-header p { color: var(--text-secondary); margin-top: 4px; }

    /* ‚îÄ‚îÄ‚îÄ Stats Cards ‚îÄ‚îÄ‚îÄ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px; transition: all 0.2s;
    }
    .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
    .stat-card .stat-icon { font-size: 28px; margin-bottom: 12px; }
    .stat-card .stat-value { font-size: 28px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
    .stat-card .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

    /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; }
    .card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

    /* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 10px 12px; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
    td { padding: 12px; font-size: 14px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--bg-hover); }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-green { background: rgba(0,210,160,0.15); color: var(--green); }
    .badge-red { background: rgba(255,107,107,0.15); color: var(--red); }
    .badge-yellow { background: rgba(255,217,61,0.15); color: var(--yellow); }
    .badge-purple { background: rgba(108,92,231,0.15); color: var(--accent-light); }

    /* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 14px;
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
    .form-actions { display: flex; gap: 8px; margin-top: 8px; }

    /* ‚îÄ‚îÄ‚îÄ Channel tree ‚îÄ‚îÄ‚îÄ */
    .channel-tree { padding: 0; }
    .channel-category { margin-bottom: 12px; }
    .channel-category-name { font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .channel-item { padding: 6px 8px 6px 24px; font-size: 14px; color: var(--text-secondary); border-radius: 4px; display: flex; align-items: center; gap: 6px; }
    .channel-item:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* ‚îÄ‚îÄ‚îÄ Info box ‚îÄ‚îÄ‚îÄ */
    .info-box { background: rgba(108,92,231,0.08); border: 1px solid rgba(108,92,231,0.2); border-radius: 10px; padding: 16px 20px; margin-bottom: 20px; font-size: 14px; color: var(--text-secondary); }
    .info-box strong { color: var(--text-primary); }

    /* ‚îÄ‚îÄ‚îÄ Config items ‚îÄ‚îÄ‚îÄ */
    .config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .config-item:last-child { border-bottom: none; }
    .config-label { font-size: 13px; color: var(--text-secondary); }
    .config-value { font-size: 14px; font-weight: 600; }

    /* ‚îÄ‚îÄ‚îÄ Pages ‚îÄ‚îÄ‚îÄ */
    .page { display: none; }
    .page.active { display: block; }
    .no-server { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .no-server .no-server-icon { font-size: 48px; margin-bottom: 16px; }
    .no-server p { font-size: 15px; }

    /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 20px; background: var(--bg-card); border: 1px solid var(--green); border-radius: 10px; font-size: 14px; z-index: 1000; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* ‚îÄ‚îÄ‚îÄ Wizard ‚îÄ‚îÄ‚îÄ */
    .wizard-steps { display: flex; gap: 4px; margin-bottom: 28px; }
    .wizard-step {
      flex: 1; padding: 10px; text-align: center; font-size: 12px; font-weight: 600;
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
      color: var(--text-secondary); transition: all 0.2s;
    }
    .wizard-step.active { background: var(--accent); color: white; border-color: var(--accent); }
    .wizard-step.done { background: rgba(0,210,160,0.15); color: var(--green); border-color: rgba(0,210,160,0.3); }
    .wizard-nav { display: flex; justify-content: space-between; margin-top: 24px; }
    .template-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .template-card {
      background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius);
      padding: 24px; cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .template-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .template-card.selected { border-color: var(--accent); background: rgba(108,92,231,0.1); }
    .template-card .tpl-icon { font-size: 40px; margin-bottom: 12px; }
    .template-card .tpl-name { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
    .template-card .tpl-stats { font-size: 12px; color: var(--text-secondary); }
    .toggle-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; border-radius: 8px; margin-bottom: 4px; transition: background 0.15s;
    }
    .toggle-row:hover { background: var(--bg-hover); }
    .toggle-row label { font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .toggle-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
    .toggle-row input[type="text"] {
      background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text-primary); padding: 4px 8px; font-size: 13px; font-family: inherit; width: 200px;
    }
    .toggle-row input[type="text"]:focus { outline: none; border-color: var(--accent); }
    .category-block { margin-bottom: 16px; }
    .category-header { font-size: 13px; font-weight: 700; color: var(--accent-light); margin-bottom: 6px; padding: 8px 12px; background: rgba(108,92,231,0.08); border-radius: 8px; display: flex; align-items: center; gap: 8px; }
    .role-color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
    .progress-log {
      background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; max-height: 400px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 13px;
    }
    .progress-log .log-line { padding: 3px 0; color: var(--text-secondary); }
    .progress-log .log-line.success { color: var(--green); }
    .progress-log .log-line.error { color: var(--red); }
    .warning-box { background: rgba(255,217,61,0.1); border: 1px solid rgba(255,217,61,0.3); border-radius: 10px; padding: 14px 18px; font-size: 13px; color: var(--yellow); margin-bottom: 16px; }
    .review-section { margin-bottom: 16px; }
    .review-section h4 { font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 8px; }
    .review-list { padding-left: 20px; font-size: 13px; color: var(--text-secondary); }
    .review-list li { padding: 2px 0; }

    /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .sidebar { width: 60px; padding: 16px 8px; }
      .sidebar .brand-name, .sidebar .brand-status, .sidebar .nav-section, .sidebar .nav-item span:not(.icon), .server-selector { display: none; }
      .main { margin-left: 60px; padding: 16px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-box">
      <h1>ü§ñ Bot Panel</h1>
      <p>Inicia sesi√≥n con tu cuenta de Discord</p>
      <div class="error-msg" id="login-error"></div>
      <a href="/api/auth/discord" class="btn btn-primary" style="margin-top:12px;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;width:100%">
        <svg width="20" height="15" viewBox="0 0 71 55" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M60.1 4.9A58.5 58.5 0 0 0 45.4.2a.2.2 0 0 0-.2.1 40.8 40.8 0 0 0-1.8 3.7 54 54 0 0 0-16.2 0A37.4 37.4 0 0 0 25.4.3a.2.2 0 0 0-.2-.1A58.4 58.4 0 0 0 10.5 5a.2.2 0 0 0-.1 0C1.5 18 -.9 30.6.3 43a.2.2 0 0 0 .1.2 58.7 58.7 0 0 0 17.7 9 .2.2 0 0 0 .3-.1 42 42 0 0 0 3.6-5.9.2.2 0 0 0-.1-.3 38.7 38.7 0 0 1-5.5-2.6.2.2 0 0 1 0-.4l1.1-.9a.2.2 0 0 1 .2 0 41.9 41.9 0 0 0 35.6 0 .2.2 0 0 1 .2 0l1.1.9a.2.2 0 0 1 0 .3c-1.8 1-3.6 1.8-5.5 2.7a.2.2 0 0 0-.1.3 47.2 47.2 0 0 0 3.6 5.8.2.2 0 0 0 .3.1A58.5 58.5 0 0 0 70.2 43a.2.2 0 0 0 .1-.2c1.4-14.7-2.4-27.4-10.1-38.7a.2.2 0 0 0-.1-.1zM23.7 35.3c-3.4 0-6.1-3.1-6.1-6.9s2.7-6.9 6.1-6.9 6.2 3.1 6.1 6.9c0 3.8-2.7 6.9-6.1 6.9zm22.6 0c-3.4 0-6.1-3.1-6.1-6.9s2.7-6.9 6.1-6.9 6.2 3.1 6.1 6.9c0 3.8-2.7 6.9-6.1 6.9z"/></svg>
        Iniciar sesi√≥n con Discord
      </a>
      <a href="/api/bot/invite" target="_blank" class="btn btn-ghost" style="margin-top:10px;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;width:100%">
        <span>‚ûï</span> A√±adir bot a un servidor
      </a>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <nav class="sidebar">
      <div class="sidebar-brand">
        <img id="bot-avatar" src="" alt="Bot">
        <div>
          <div class="brand-name" id="bot-name">Bot</div>
          <div class="brand-status">‚óè Online</div>
        </div>
      </div>

      <!-- Server Selector -->
      <div class="server-selector">
        <label>Servidor</label>
        <select id="guild-select" onchange="onGuildSelect()">
          <option value="">Selecciona un servidor...</option>
        </select>
      </div>

      <div class="nav-section">Principal</div>
      <div class="nav-item active" data-page="overview" onclick="showPage('overview')">
        <span class="icon">üìä</span><span>Overview</span>
      </div>

      <div class="nav-section">Gesti√≥n del servidor</div>
      <div class="nav-item" data-page="server-info" onclick="showPage('server-info')">
        <span class="icon">üè†</span><span>Info & Canales</span>
      </div>
      <div class="nav-item" data-page="announcements" onclick="showPage('announcements')">
        <span class="icon">üì¢</span><span>Anuncios</span>
      </div>
      <div class="nav-item" data-page="messages" onclick="showPage('messages')">
        <span class="icon">üí¨</span><span>Enviar Mensaje</span>
      </div>
      <div class="nav-item" data-page="automod" onclick="showPage('automod')">
        <span class="icon">üõ°Ô∏è</span><span>AutoMod</span>
      </div>
      <div class="nav-item" data-page="warnings-page" onclick="showPage('warnings-page')">
        <span class="icon">‚ö†Ô∏è</span><span>Warnings</span>
      </div>
      <div class="nav-item" data-page="verification" onclick="showPage('verification')">
        <span class="icon">üîê</span><span>Verificaci√≥n</span>
      </div>
      <div class="nav-item" data-page="ranks" onclick="showPage('ranks')">
        <span class="icon">üèõÔ∏è</span><span>Rangos Egipcios</span>
      </div>
      <div class="nav-item" data-page="wallets" onclick="showPage('wallets')">
        <span class="icon">üîó</span><span>Wallets</span>
      </div>
      <div class="nav-item" data-page="tickets" onclick="showPage('tickets')">
        <span class="icon">üé´</span><span>Tickets</span>
      </div>
      <div class="nav-item" data-page="setup-wizard" onclick="showPage('setup-wizard')">
        <span class="icon">üõ†Ô∏è</span><span>Customize</span>
      </div>

      <div class="sidebar-footer">
        <a href="/api/bot/invite" target="_blank" class="nav-item" style="text-decoration:none;color:inherit">
          <span class="icon">‚ûï</span><span>A√±adir a servidor</span>
        </a>
        <div class="nav-item" onclick="logout()">
          <span class="icon">üö™</span><span>Cerrar sesi√≥n</span>
        </div>
      </div>
    </nav>

    <div class="main">

      <!-- OVERVIEW PAGE -->
      <div class="page active" id="page-overview">
        <div class="page-header">
          <h2>Dashboard</h2>
          <p>Vista general del bot</p>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon">üè†</div><div class="stat-value" id="stat-guilds">-</div><div class="stat-label">Servidores</div></div>
          <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value" id="stat-members">-</div><div class="stat-label">Miembros totales</div></div>
          <div class="stat-card"><div class="stat-icon">üí¨</div><div class="stat-value" id="stat-channels">-</div><div class="stat-label">Canales</div></div>
          <div class="stat-card"><div class="stat-icon">üì°</div><div class="stat-value" id="stat-ping">-</div><div class="stat-label">Latencia (ms)</div></div>
          <div class="stat-card"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-value" id="stat-uptime">-</div><div class="stat-label">Uptime</div></div>
        </div>
        <div class="card">
          <h3>üìÖ Anuncios Programados</h3>
          <table>
            <thead><tr><th>ID</th><th>T√≠tulo</th><th>Frecuencia</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="overview-announcements"></tbody>
          </table>
        </div>
      </div>

      <!-- SERVER INFO PAGE -->
      <div class="page" id="page-server-info">
        <div id="server-info-content"></div>
      </div>

      <!-- ANNOUNCEMENTS PAGE -->
      <div class="page" id="page-announcements">
        <div id="announcements-content"></div>
      </div>

      <!-- MESSAGES PAGE -->
      <div class="page" id="page-messages">
        <div id="messages-content"></div>
      </div>

      <!-- AUTOMOD PAGE -->
      <div class="page" id="page-automod">
        <div id="automod-content"></div>
      </div>

      <!-- WARNINGS PAGE -->
      <div class="page" id="page-warnings-page">
        <div id="warnings-content"></div>
      </div>

      <!-- VERIFICATION PAGE -->
      <div class="page" id="page-verification">
        <div id="verification-content"></div>
      </div>

      <!-- RANKS PAGE -->
      <div class="page" id="page-ranks">
        <div id="ranks-content"></div>
      </div>

      <!-- WALLETS PAGE -->
      <div class="page" id="page-wallets">
        <div id="wallets-content"></div>
      </div>

      <!-- TICKETS PAGE -->
      <div class="page" id="page-tickets">
        <div id="tickets-content"></div>
      </div>

      <!-- SETUP WIZARD PAGE -->
      <div class="page" id="page-setup-wizard">
        <div id="setup-wizard-content"></div>
      </div>

    </div>
  </div>

  <script>
    const API = '';
    let currentGuild = null;
    let currentGuildData = null;
    let allGuilds = [];

    // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
    async function checkAuth() {
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      if (error) {
        const el = document.getElementById('login-error');
        const msgs = { unauthorized: 'Tu cuenta de Discord no tiene acceso a este panel.', token_failed: 'Error al autenticar con Discord. Intenta de nuevo.', no_code: 'Error en el proceso de login. Intenta de nuevo.', server_error: 'Error del servidor. Intenta de nuevo.' };
        el.textContent = msgs[error] || 'Error desconocido';
        el.style.display = 'block';
        window.history.replaceState({}, '', '/');
      }
      try {
        const res = await fetch(`${API}/api/auth-check`);
        const data = await res.json();
        if (data.authenticated) {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          loadDashboard();
        }
      } catch {}
    }

    async function logout() {
      await fetch(`${API}/api/logout`, { method: 'POST' });
      location.reload();
    }

    // ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item[data-page]').forEach(n => n.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');
      const navItem = document.querySelector(`[data-page="${page}"]`);
      if (navItem) navItem.classList.add('active');

      if (page === 'server-info') renderServerInfo();
      if (page === 'announcements') renderAnnouncements();
      if (page === 'messages') renderMessages();
      if (page === 'automod') renderAutomod();
      if (page === 'warnings-page') renderWarnings();
      if (page === 'verification') renderVerification();
      if (page === 'tickets') renderTickets();
      if (page === 'ranks') renderRanks();
      if (page === 'wallets') renderWallets();
      if (page === 'setup-wizard') renderSetupWizard();
    }

    function noServerHtml(action) {
      return `<div class="no-server"><div class="no-server-icon">üè†</div><p>Selecciona un servidor en el panel izquierdo para ${action}</p></div>`;
    }

    // ‚îÄ‚îÄ‚îÄ Load Dashboard ‚îÄ‚îÄ‚îÄ
    async function loadDashboard() {
      try {
        const [statsRes, guildsRes] = await Promise.all([
          fetch(`${API}/api/stats`),
          fetch(`${API}/api/guilds`)
        ]);
        const stats = await statsRes.json();
        allGuilds = await guildsRes.json();

        document.getElementById('bot-name').textContent = stats.botName || 'Bot';
        document.getElementById('bot-avatar').src = stats.botAvatar || '';
        document.getElementById('stat-guilds').textContent = stats.guilds || 0;
        document.getElementById('stat-members').textContent = (stats.members || 0).toLocaleString();
        document.getElementById('stat-channels').textContent = stats.channels || 0;
        document.getElementById('stat-ping').textContent = stats.ping || '-';
        const uptime = stats.uptime || 0;
        document.getElementById('stat-uptime').textContent = `${Math.floor(uptime / 3600)}h ${Math.floor((uptime % 3600) / 60)}m`;

        // Populate server selector
        const select = document.getElementById('guild-select');
        const prevVal = select.value;
        select.innerHTML = '<option value="">Selecciona un servidor...</option>';
        allGuilds.forEach(g => {
          select.innerHTML += `<option value="${g.id}">${g.name} (${g.members} miembros)</option>`;
        });
        if (prevVal) select.value = prevVal;

        // Auto-select if only one guild
        if (!currentGuild && allGuilds.length === 1) {
          select.value = allGuilds[0].id;
          onGuildSelect();
        }

        loadAnnouncementsOverview();
      } catch (err) { console.error('Error loading dashboard:', err); }
    }

    // ‚îÄ‚îÄ‚îÄ Guild Selection ‚îÄ‚îÄ‚îÄ
    async function onGuildSelect() {
      const id = document.getElementById('guild-select').value;
      if (!id) { currentGuild = null; currentGuildData = null; return; }
      currentGuild = id;
      try {
        const res = await fetch(`${API}/api/guilds/${id}`);
        currentGuildData = await res.json();
      } catch { currentGuildData = null; }
      // Refresh current page if it's a server-dependent page
      const activePage = document.querySelector('.page.active');
      if (activePage) {
        const pageId = activePage.id.replace('page-', '');
        if (['server-info', 'announcements', 'messages', 'automod', 'warnings-page', 'verification', 'tickets', 'ranks', 'wallets', 'setup-wizard'].includes(pageId)) {
          showPage(pageId);
        }
      }
    }

    // ‚îÄ‚îÄ‚îÄ Server Info Page ‚îÄ‚îÄ‚îÄ
    function renderServerInfo() {
      const el = document.getElementById('server-info-content');
      if (!currentGuild || !currentGuildData) { el.innerHTML = noServerHtml('ver su informaci√≥n'); return; }
      const g = currentGuildData;

      // Group channels
      const categories = {};
      g.channels.forEach(c => { if (c.type === 4) categories[c.id] = { name: c.name, channels: [] }; });
      g.channels.forEach(c => { if (c.type !== 4) { if (c.parent && categories[c.parent]) categories[c.parent].channels.push(c); } });

      const typeIcons = { 0: '#', 2: 'üîä', 5: 'üì¢', 15: 'üí¨' };
      let channelHtml = '';
      for (const [, cat] of Object.entries(categories)) {
        channelHtml += `<div class="channel-category"><div class="channel-category-name">üìÅ ${cat.name}</div>`;
        cat.channels.forEach(c => { channelHtml += `<div class="channel-item">${typeIcons[c.type] || '#'} ${c.name}</div>`; });
        channelHtml += '</div>';
      }

      const rolesHtml = g.roles.filter(r => r.name !== '@everyone')
        .map(r => `<div style="padding:4px 0;font-size:14px"><span style="color:${r.color};font-weight:600">‚óè ${r.name}</span> <span style="color:var(--text-secondary);font-size:12px">(${r.members})</span></div>`).join('');

      el.innerHTML = `
        <div class="page-header"><h2>üè† ${g.name}</h2><p>${g.members} miembros ¬∑ ${g.channels.length} canales ¬∑ ${g.roles.length} roles</p></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value">${g.members}</div><div class="stat-label">Miembros</div></div>
          <div class="stat-card"><div class="stat-icon">üí¨</div><div class="stat-value">${g.channels.filter(c=>c.type===0).length}</div><div class="stat-label">Canales de texto</div></div>
          <div class="stat-card"><div class="stat-icon">üîä</div><div class="stat-value">${g.channels.filter(c=>c.type===2).length}</div><div class="stat-label">Canales de voz</div></div>
          <div class="stat-card"><div class="stat-icon">üé≠</div><div class="stat-value">${g.roles.length}</div><div class="stat-label">Roles</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="card"><h3>üí¨ Canales</h3><div class="channel-tree">${channelHtml || '<p style="color:var(--text-secondary)">Sin canales</p>'}</div></div>
          <div class="card"><h3>üé≠ Roles</h3>${rolesHtml || '<p style="color:var(--text-secondary)">Sin roles</p>'}</div>
        </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ Channel dropdown helper ‚îÄ‚îÄ‚îÄ
    function channelOptions(typeFilter) {
      if (!currentGuildData) return '<option value="">Sin servidor</option>';
      const channels = currentGuildData.channels.filter(c => {
        if (typeFilter === 'text') return c.type === 0 || c.type === 5;
        return true;
      });
      let html = '<option value="">Selecciona canal...</option>';
      channels.forEach(c => {
        const icon = c.type === 2 ? 'üîä' : c.type === 5 ? 'üì¢' : '#';
        html += `<option value="${c.id}">${icon} ${c.name}</option>`;
      });
      return html;
    }

    // ‚îÄ‚îÄ‚îÄ Announcements Page ‚îÄ‚îÄ‚îÄ
    async function renderAnnouncements() {
      const el = document.getElementById('announcements-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('gestionar anuncios'); return; }

      el.innerHTML = `
        <div class="page-header"><h2>üì¢ Anuncios ‚Äî ${currentGuildData?.name || ''}</h2><p>Crea y gestiona anuncios programados para este servidor</p></div>
        <div class="card">
          <h3>‚ûï Nuevo Anuncio Programado</h3>
          <div class="form-grid">
            <div class="form-group"><label>Canal</label><select id="ann-channel">${channelOptions('text')}</select></div>
            <div class="form-group"><label>Frecuencia</label>
              <select id="ann-cron">
                <option value="0 * * * *">Cada hora</option><option value="0 */6 * * *">Cada 6 horas</option>
                <option value="0 8 * * *">Diario (8 AM)</option><option value="0 12 * * *">Diario (12 PM)</option>
                <option value="0 20 * * *">Diario (8 PM)</option><option value="0 9 * * 1-5">Lun-Vie (9 AM)</option>
                <option value="0 9 * * 1">Semanal (Lunes)</option><option value="0 9 1 * *">Mensual (d√≠a 1)</option>
              </select>
            </div>
            <div class="form-group"><label>T√≠tulo</label><input type="text" id="ann-title" placeholder="T√≠tulo del anuncio"></div>
            <div class="form-group"><label>Color</label><input type="color" id="ann-color" value="#6c5ce7"></div>
          </div>
          <div class="form-group"><label>Mensaje</label><textarea id="ann-message" placeholder="Contenido del anuncio..."></textarea></div>
          <div class="form-actions"><button class="btn btn-primary" onclick="createAnnouncement()">Crear Anuncio</button></div>
        </div>
        <div class="card"><h3>üìã Anuncios Activos</h3>
          <table><thead><tr><th>ID</th><th>T√≠tulo</th><th>Canal</th><th>Frecuencia</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody id="announcements-table"></tbody></table>
        </div>`;

      const res = await fetch(`${API}/api/announcements`);
      const data = await res.json();
      // Filter by guild channels
      const guildChannelIds = currentGuildData ? currentGuildData.channels.map(c => c.id) : [];
      const filtered = {};
      for (const [id, a] of Object.entries(data)) {
        if (a.guildId === currentGuild || guildChannelIds.includes(a.channelId)) filtered[id] = a;
      }
      renderAnnouncementsTable(filtered, 'announcements-table');
    }

    function renderAnnouncementsTable(data, tableId) {
      const tbody = document.getElementById(tableId);
      if (!tbody) return;
      const entries = Object.entries(data);
      if (!entries.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary)">No hay anuncios programados</td></tr>'; return; }
      const channelName = (id) => { if (!currentGuildData) return id?.slice(-6) || '-'; const ch = currentGuildData.channels.find(c => c.id === id); return ch ? `#${ch.name}` : id?.slice(-6) || '-'; };
      tbody.innerHTML = entries.map(([id, a]) => `<tr>
        <td><code style="color:var(--accent-light)">${id}</code></td>
        <td>${a.title || '-'}</td>
        <td>${channelName(a.channelId)}</td>
        <td><code style="font-size:12px">${a.cron || '-'}</code></td>
        <td><span class="badge ${a.active ? 'badge-green' : 'badge-red'}">${a.active ? 'Activo' : 'Pausado'}</span></td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteAnnouncement('${id}')">üóëÔ∏è</button></td>
      </tr>`).join('');
    }

    async function loadAnnouncementsOverview() {
      const res = await fetch(`${API}/api/announcements`);
      const data = await res.json();
      renderAnnouncementsTable(data, 'overview-announcements');
    }

    async function createAnnouncement() {
      const body = {
        channelId: document.getElementById('ann-channel').value,
        title: document.getElementById('ann-title').value,
        message: document.getElementById('ann-message').value,
        cron: document.getElementById('ann-cron').value,
        color: document.getElementById('ann-color').value,
        guildId: currentGuild,
        active: true,
      };
      if (!body.channelId || !body.message) return toast('Selecciona canal y escribe un mensaje', true);
      const res = await fetch(`${API}/api/announcements`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (res.ok) { toast('‚úÖ Anuncio creado'); renderAnnouncements(); }
    }

    async function deleteAnnouncement(id) {
      if (!confirm('¬øEliminar este anuncio?')) return;
      await fetch(`${API}/api/announcements/${id}`, { method: 'DELETE' });
      toast('üóëÔ∏è Anuncio eliminado');
      renderAnnouncements();
      loadAnnouncementsOverview();
    }

    // ‚îÄ‚îÄ‚îÄ Messages Page ‚îÄ‚îÄ‚îÄ
    function renderMessages() {
      const el = document.getElementById('messages-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('send messages'); return; }

      el.innerHTML = `
        <div class="page-header"><h2>üí¨ Send Message ‚Äî ${currentGuildData?.name || ''}</h2><p>Send a message as the bot to a channel</p></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start">
          <div class="card">
            <h3>üí¨ New Message</h3>
            <div class="form-group"><label>Channel</label><select id="msg-channel">${channelOptions('text')}</select></div>
            <div class="form-group"><label>Content (plain text)</label><textarea id="msg-content" placeholder="Text message..." oninput="updateEmbedPreview()"></textarea></div>
            <h4 style="margin:16px 0 12px;font-size:14px;color:var(--text-secondary)">Embed Builder:</h4>
            <div class="form-grid">
              <div class="form-group"><label>Title</label><input type="text" id="msg-embed-title" placeholder="Embed title" oninput="updateEmbedPreview()"></div>
              <div class="form-group"><label>Color</label><input type="color" id="msg-embed-color" value="#6c5ce7" oninput="updateEmbedPreview()"></div>
            </div>
            <div class="form-group"><label>Description</label><textarea id="msg-embed-desc" placeholder="Embed content... (supports **bold**, *italic*, [links](url))" oninput="updateEmbedPreview()"></textarea></div>
            <div class="form-grid">
              <div class="form-group"><label>Image URL</label><input type="text" id="msg-embed-image" placeholder="https://i.imgur.com/example.png" oninput="updateEmbedPreview()"></div>
              <div class="form-group"><label>Thumbnail URL</label><input type="text" id="msg-embed-thumb" placeholder="https://i.imgur.com/thumb.png" oninput="updateEmbedPreview()"></div>
            </div>
            <div class="form-grid">
              <div class="form-group"><label>Footer text</label><input type="text" id="msg-embed-footer" placeholder="Footer text" oninput="updateEmbedPreview()"></div>
              <div class="form-group"><label>Footer icon URL</label><input type="text" id="msg-embed-footer-icon" placeholder="https://i.imgur.com/icon.png" oninput="updateEmbedPreview()"></div>
            </div>
            <div class="form-actions"><button class="btn btn-primary" onclick="sendMessage()">Send</button></div>
          </div>
          <div class="card" style="position:sticky;top:20px">
            <h3>üëÅÔ∏è Preview</h3>
            <div id="embed-preview" style="background:var(--bg-primary);border-radius:8px;padding:16px;min-height:80px">
              <span style="color:var(--text-secondary);font-size:13px">Start typing to see the preview...</span>
            </div>
          </div>
        </div>`;
    }

    function updateEmbedPreview() {
      const title = document.getElementById('msg-embed-title')?.value || '';
      const desc = document.getElementById('msg-embed-desc')?.value || '';
      const color = document.getElementById('msg-embed-color')?.value || '#6c5ce7';
      const image = document.getElementById('msg-embed-image')?.value || '';
      const thumb = document.getElementById('msg-embed-thumb')?.value || '';
      const footer = document.getElementById('msg-embed-footer')?.value || '';
      const footerIcon = document.getElementById('msg-embed-footer-icon')?.value || '';
      const content = document.getElementById('msg-content')?.value || '';
      const preview = document.getElementById('embed-preview');
      if (!preview) return;

      if (!title && !desc && !content && !image) {
        preview.innerHTML = '<span style="color:var(--text-secondary);font-size:13px">Start typing to see the preview...</span>';
        return;
      }

      let html = '';
      if (content) html += `<div style="margin-bottom:12px;color:var(--text-primary);font-size:14px">${content.replace(/\n/g, '<br>')}</div>`;
      if (title || desc || image || thumb) {
        html += `<div style="border-left:4px solid ${color};border-radius:4px;background:var(--bg-secondary);padding:12px;position:relative">`;
        if (thumb) html += `<img src="${thumb}" alt="" style="float:right;max-width:80px;max-height:80px;border-radius:6px;margin-left:12px" onerror="this.style.display='none'" onload="this.style.display='block'">`;
        if (title) html += `<div style="font-weight:700;color:var(--text-primary);font-size:15px;margin-bottom:6px">${title}</div>`;
        if (desc) html += `<div style="color:var(--text-secondary);font-size:13px;line-height:1.4;white-space:pre-wrap">${desc.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>')}</div>`;
        if (image) html += `<img src="${image}" alt="" style="max-width:100%;border-radius:6px;margin-top:10px" onerror="this.style.display='none'" onload="this.style.display='block'">`;
        if (footer) {
          html += `<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border);display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-secondary)">`;
          if (footerIcon) html += `<img src="${footerIcon}" alt="" style="width:16px;height:16px;border-radius:50%" onerror="this.style.display='none'">`;
          html += `${footer}</div>`;
        }
        html += '</div>';
      }
      preview.innerHTML = html;
    }

    async function sendMessage() {
      const channelId = document.getElementById('msg-channel').value;
      const content = document.getElementById('msg-content').value;
      const embedTitle = document.getElementById('msg-embed-title').value;
      const embedDesc = document.getElementById('msg-embed-desc').value;
      const embedColor = document.getElementById('msg-embed-color').value;
      const embedImage = document.getElementById('msg-embed-image').value;
      const embedThumb = document.getElementById('msg-embed-thumb').value;
      const embedFooter = document.getElementById('msg-embed-footer').value;
      const embedFooterIcon = document.getElementById('msg-embed-footer-icon').value;
      if (!channelId) return toast('Select a channel', true);
      if (!content && !embedDesc && !embedTitle) return toast('Write a message or embed', true);
      const body = { channelId };
      if (content) body.content = content;
      if (embedTitle || embedDesc || embedImage) {
        body.embed = {};
        if (embedTitle) body.embed.title = embedTitle;
        if (embedDesc) body.embed.description = embedDesc;
        if (embedColor) body.embed.color = embedColor;
        if (embedImage) body.embed.image = embedImage;
        if (embedThumb) body.embed.thumbnail = embedThumb;
        if (embedFooter) body.embed.footer = embedFooter;
        if (embedFooterIcon) body.embed.footerIcon = embedFooterIcon;
      }
      const res = await fetch(`${API}/api/send-message`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (res.ok) {
        toast('Message sent!');
        document.getElementById('msg-content').value = '';
        document.getElementById('msg-embed-title').value = '';
        document.getElementById('msg-embed-desc').value = '';
        document.getElementById('msg-embed-image').value = '';
        document.getElementById('msg-embed-thumb').value = '';
        document.getElementById('msg-embed-footer').value = '';
        document.getElementById('msg-embed-footer-icon').value = '';
        updateEmbedPreview();
      } else { const err = await res.json(); toast(`Error: ${err.error}`, true); }
    }

    // ‚îÄ‚îÄ‚îÄ AutoMod Page ‚îÄ‚îÄ‚îÄ
    let automodConfig = null;

    async function renderAutomod() {
      const el = document.getElementById('automod-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('configure automod'); return; }
      el.innerHTML = '<div class="page-header"><h2>üõ°Ô∏è AutoMod</h2><p>Loading...</p></div>';

      try {
        const res = await fetch(`${API}/api/automod/${currentGuild}`);
        automodConfig = await res.json();
      } catch {
        el.innerHTML = '<div class="card"><p style="color:var(--red)">Error loading automod config</p></div>';
        return;
      }

      const c = automodConfig;
      const logChOpts = '<option value="">None (disabled)</option>' + (currentGuildData?.channels?.filter(ch => ch.type === 0).map(ch => `<option value="${ch.id}" ${c.logChannelId === ch.id ? 'selected' : ''}>#${ch.name}</option>`).join('') || '');
      const roleOpts = currentGuildData?.roles?.filter(r => r.name !== '@everyone').map(r => `<option value="${r.id}" ${(c.immuneRoleIds || []).includes(r.id) ? 'selected' : ''}>${r.name}</option>`).join('') || '';

      function toggle(label, key, enabled) {
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-weight:600">${label}</span><label style="cursor:pointer"><input type="checkbox" id="am-${key}" ${enabled ? 'checked' : ''} onchange="updateAutomodField('${key}')"> Enabled</label></div>`;
      }

      el.innerHTML = `
        <div class="page-header"><h2>üõ°Ô∏è AutoMod ‚Äî ${currentGuildData?.name || ''}</h2><p>Automated moderation with no human moderators needed</p></div>

        <div class="card">
          <h3>‚ö° Master Switch</h3>
          <div style="display:flex;align-items:center;gap:12px">
            <label style="font-size:16px;cursor:pointer"><input type="checkbox" id="am-enabled" ${c.enabled ? 'checked' : ''} style="width:20px;height:20px"> <strong>AutoMod ${c.enabled ? 'ON' : 'OFF'}</strong></label>
          </div>
          <div class="form-grid" style="margin-top:12px">
            <div class="form-group"><label>Log Channel</label><select id="am-log-channel">${logChOpts}</select></div>
            <div class="form-group"><label>Immune Roles (bypass automod)</label><select id="am-immune-roles" multiple size="4" style="width:100%;padding:6px;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary)">${roleOpts}</select></div>
          </div>
        </div>

        <div class="card">
          <h3>üö´ Spam Filter</h3>
          ${toggle('Rate Limit & Duplicate Detection', 'spam', c.spamFilter?.enabled)}
          <div class="form-grid" style="margin-top:10px">
            <div class="form-group"><label>Max messages in window</label><input type="number" id="am-spam-max" value="${c.spamFilter?.maxMessages || 5}" min="2" max="20"></div>
            <div class="form-group"><label>Time window (ms)</label><input type="number" id="am-spam-window" value="${c.spamFilter?.timeWindow || 5000}" min="1000" max="30000" step="1000"></div>
            <div class="form-group"><label>Duplicate threshold</label><input type="number" id="am-spam-dupes" value="${c.spamFilter?.duplicateThreshold || 3}" min="2" max="10"></div>
            <div class="form-group"><label>Mute duration (min)</label><input type="number" id="am-spam-mute" value="${c.spamFilter?.muteDuration || 10}" min="1" max="1440"></div>
          </div>
        </div>

        <div class="card">
          <h3>üî§ Word Filter</h3>
          ${toggle('Block blacklisted words/phrases', 'words', c.wordFilter?.enabled)}
          <div class="form-group" style="margin-top:10px"><label>Blacklist (one per line)</label><textarea id="am-word-blacklist" rows="4" placeholder="badword1\nbadphrase two\netc">${(c.wordFilter?.blacklist || []).join('\n')}</textarea></div>
        </div>

        <div class="card">
          <h3>üîó Link Filter</h3>
          ${toggle('Block links and Discord invites', 'links', c.linkFilter?.enabled)}
          <div class="form-grid" style="margin-top:10px">
            <div class="form-group"><label><input type="checkbox" id="am-link-invites" ${c.linkFilter?.blockInvites ? 'checked' : ''}> Block Discord invites</label></div>
            <div class="form-group"><label><input type="checkbox" id="am-link-all" ${c.linkFilter?.blockAllLinks ? 'checked' : ''}> Block all links (except whitelist)</label></div>
          </div>
          <div class="form-group"><label>Whitelist domains (one per line)</label><textarea id="am-link-whitelist" rows="3" placeholder="youtube.com\ntwitter.com">${(c.linkFilter?.whitelist || []).join('\n')}</textarea></div>
        </div>

        <div class="card">
          <h3>üì¢ Mention Spam</h3>
          ${toggle('Block mass mentions', 'mentions', c.mentionSpam?.enabled)}
          <div class="form-grid" style="margin-top:10px">
            <div class="form-group"><label>Max mentions per message</label><input type="number" id="am-mention-max" value="${c.mentionSpam?.maxMentions || 5}" min="2" max="30"></div>
            <div class="form-group"><label>Mute duration (min)</label><input type="number" id="am-mention-mute" value="${c.mentionSpam?.muteDuration || 5}" min="1" max="1440"></div>
          </div>
        </div>

        <div class="card">
          <h3>üî† Caps Filter</h3>
          ${toggle('Block excessive CAPS', 'caps', c.capsFilter?.enabled)}
          <div class="form-grid" style="margin-top:10px">
            <div class="form-group"><label>Max caps percentage</label><input type="number" id="am-caps-pct" value="${c.capsFilter?.maxCapsPercent || 70}" min="50" max="100">%</div>
            <div class="form-group"><label>Min message length to check</label><input type="number" id="am-caps-minlen" value="${c.capsFilter?.minLength || 10}" min="5" max="50"></div>
          </div>
        </div>

        <div class="card">
          <h3>üõ°Ô∏è Anti-Raid</h3>
          ${toggle('Detect mass joins and lockdown', 'raid', c.antiRaid?.enabled)}
          <div class="form-grid" style="margin-top:10px">
            <div class="form-group"><label>Max joins to trigger</label><input type="number" id="am-raid-max" value="${c.antiRaid?.maxJoins || 10}" min="3" max="50"></div>
            <div class="form-group"><label>Time window (seconds)</label><input type="number" id="am-raid-window" value="${c.antiRaid?.timeWindow || 30}" min="5" max="120"></div>
            <div class="form-group"><label>Lockdown duration (seconds)</label><input type="number" id="am-raid-duration" value="${c.antiRaid?.lockdownDuration || 300}" min="30" max="3600"></div>
          </div>
        </div>

        <div class="card">
          <h3>‚öñÔ∏è Warning Escalation</h3>
          ${toggle('Auto-action on warning accumulation', 'escalation', c.escalation?.enabled)}
          <div id="am-thresholds" style="margin-top:10px">
            ${(c.escalation?.thresholds || []).map((t, i) => `
              <div class="form-grid" style="align-items:end;margin-bottom:6px">
                <div class="form-group"><label>Warns</label><input type="number" id="am-esc-warns-${i}" value="${t.warns}" min="1" max="20"></div>
                <div class="form-group"><label>Action</label><select id="am-esc-action-${i}"><option value="mute" ${t.action === 'mute' ? 'selected' : ''}>Mute</option><option value="kick" ${t.action === 'kick' ? 'selected' : ''}>Kick</option><option value="ban" ${t.action === 'ban' ? 'selected' : ''}>Ban</option></select></div>
                <div class="form-group"><label>Duration (min, mute only)</label><input type="number" id="am-esc-dur-${i}" value="${t.duration || 0}" min="0"></div>
              </div>`).join('')}
          </div>
        </div>

        <div class="form-actions" style="margin-top:20px"><button class="btn btn-primary" onclick="saveAutomod()" style="font-size:16px;padding:12px 32px">üíæ Save AutoMod Config</button></div>`;
    }

    async function saveAutomod() {
      const config = {
        enabled: document.getElementById('am-enabled').checked,
        logChannelId: document.getElementById('am-log-channel').value || null,
        immuneRoleIds: Array.from(document.getElementById('am-immune-roles').selectedOptions).map(o => o.value),
        spamFilter: {
          enabled: document.getElementById('am-spam')?.checked || false,
          maxMessages: parseInt(document.getElementById('am-spam-max')?.value) || 5,
          timeWindow: parseInt(document.getElementById('am-spam-window')?.value) || 5000,
          duplicateThreshold: parseInt(document.getElementById('am-spam-dupes')?.value) || 3,
          action: 'mute',
          muteDuration: parseInt(document.getElementById('am-spam-mute')?.value) || 10,
        },
        wordFilter: {
          enabled: document.getElementById('am-words')?.checked || false,
          blacklist: (document.getElementById('am-word-blacklist')?.value || '').split('\n').map(w => w.trim()).filter(Boolean),
          action: 'delete_warn',
        },
        linkFilter: {
          enabled: document.getElementById('am-links')?.checked || false,
          blockInvites: document.getElementById('am-link-invites')?.checked || false,
          blockAllLinks: document.getElementById('am-link-all')?.checked || false,
          whitelist: (document.getElementById('am-link-whitelist')?.value || '').split('\n').map(w => w.trim()).filter(Boolean),
          action: 'delete_warn',
        },
        mentionSpam: {
          enabled: document.getElementById('am-mentions')?.checked || false,
          maxMentions: parseInt(document.getElementById('am-mention-max')?.value) || 5,
          action: 'mute',
          muteDuration: parseInt(document.getElementById('am-mention-mute')?.value) || 5,
        },
        capsFilter: {
          enabled: document.getElementById('am-caps')?.checked || false,
          maxCapsPercent: parseInt(document.getElementById('am-caps-pct')?.value) || 70,
          minLength: parseInt(document.getElementById('am-caps-minlen')?.value) || 10,
          action: 'delete',
        },
        antiRaid: {
          enabled: document.getElementById('am-raid')?.checked || false,
          maxJoins: parseInt(document.getElementById('am-raid-max')?.value) || 10,
          timeWindow: parseInt(document.getElementById('am-raid-window')?.value) || 30,
          action: 'lockdown',
          lockdownDuration: parseInt(document.getElementById('am-raid-duration')?.value) || 300,
        },
        escalation: {
          enabled: document.getElementById('am-escalation')?.checked || false,
          thresholds: [0, 1, 2].map(i => ({
            warns: parseInt(document.getElementById(`am-esc-warns-${i}`)?.value) || (i === 0 ? 3 : i === 1 ? 5 : 7),
            action: document.getElementById(`am-esc-action-${i}`)?.value || 'mute',
            duration: parseInt(document.getElementById(`am-esc-dur-${i}`)?.value) || 0,
          })),
        },
      };
      try {
        const res = await fetch(`${API}/api/automod/${currentGuild}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        if (res.ok) toast('AutoMod config saved!');
        else toast('Error saving config', true);
      } catch { toast('Error saving config', true); }
    }

    // ‚îÄ‚îÄ‚îÄ Warnings Page ‚îÄ‚îÄ‚îÄ
    async function renderWarnings() {
      const el = document.getElementById('warnings-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('ver advertencias'); return; }

      el.innerHTML = `
        <div class="page-header"><h2>‚ö†Ô∏è Warnings ‚Äî ${currentGuildData?.name || ''}</h2><p>Moderation warning history for this server</p></div>
        <div class="card"><table><thead><tr><th>User ID</th><th>Reason</th><th>Moderator</th><th>Date</th></tr></thead>
        <tbody id="warnings-table"></tbody></table></div>`;

      const res = await fetch(`${API}/api/warnings`);
      const data = await res.json();
      const tbody = document.getElementById('warnings-table');
      const rows = [];
      for (const [key, list] of Object.entries(data)) {
        const parts = key.split('-');
        const guildId = parts[0];
        const userId = parts[1] || key;
        if (guildId !== currentGuild) continue;
        for (const w of list) {
          rows.push(`<tr><td><code>${userId}</code></td><td>${w.reason}</td><td>${w.mod || '-'}</td><td>${w.date ? new Date(w.date).toLocaleDateString() : '-'}</td></tr>`);
        }
      }
      tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">No warnings in this server</td></tr>';
    }

    // ‚îÄ‚îÄ‚îÄ Verification Page ‚îÄ‚îÄ‚îÄ
    async function renderVerification() {
      const el = document.getElementById('verification-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('ver la verificaci√≥n'); return; }

      el.innerHTML = '<div class="page-header"><h2>üîê Verificaci√≥n</h2><p>Cargando configuraci√≥n...</p></div>';

      try {
        const res = await fetch(`${API}/api/settings/${currentGuild}`);
        const data = await res.json();
        const v = data.verify || {};

        const typeNames = { puzzle: 'üß© Puzzle ‚Äî Resolver acertijo', colors: 'üé® Colores ‚Äî Secuencia de emojis', math: 'üî¢ Matem√°ticas ‚Äî Resolver operaci√≥n', question: 'üìù Pregunta ‚Äî Respuesta libre' };

        if (v.channelId) {
          const channelName = currentGuildData?.channels.find(c => c.id === v.channelId)?.name || v.channelId;
          const roleName = currentGuildData?.roles.find(r => r.id === v.roleId)?.name || v.roleId;

          el.innerHTML = `
            <div class="page-header"><h2>üîê Verificaci√≥n ‚Äî ${currentGuildData?.name || ''}</h2><p>Sistema de verificaci√≥n creativa configurado</p></div>
            <div class="card">
              <h3>‚úÖ Verificaci√≥n Activa</h3>
              <div class="config-item"><span class="config-label">Canal</span><span class="config-value">#${channelName}</span></div>
              <div class="config-item"><span class="config-label">Rol asignado</span><span class="config-value">@${roleName}</span></div>
              <div class="config-item"><span class="config-label">Tipo de desaf√≠o</span><span class="config-value">${typeNames[v.type] || v.type}</span></div>
            </div>
            <div class="info-box">
              <strong>Para cambiar la configuraci√≥n</strong> usa el comando <code>/setupverify</code> en Discord.<br>
              Opciones: canal, rol a dar, y tipo de verificaci√≥n (puzzle, colores, matem√°ticas, pregunta).
            </div>`;
        } else {
          el.innerHTML = `
            <div class="page-header"><h2>üîê Verificaci√≥n ‚Äî ${currentGuildData?.name || ''}</h2><p>Sistema de verificaci√≥n creativa</p></div>
            <div class="card" style="text-align:center;padding:40px">
              <div style="font-size:48px;margin-bottom:16px">üîê</div>
              <h3 style="justify-content:center">Verificaci√≥n no configurada</h3>
              <p style="color:var(--text-secondary);margin-top:8px">Usa el comando <code>/setupverify</code> en Discord para activarla.</p>
              <div class="info-box" style="text-align:left;margin-top:20px">
                <strong>C√≥mo configurar:</strong><br><br>
                <code>/setupverify canal:#verificaci√≥n rol:@Verificado tipo:Puzzle</code><br><br>
                <strong>Tipos disponibles:</strong><br>
                üß© <strong>Puzzle</strong> ‚Äî Resolver un acertijo en espa√±ol<br>
                üé® <strong>Colores</strong> ‚Äî Memorizar secuencia de emojis<br>
                üî¢ <strong>Matem√°ticas</strong> ‚Äî Resolver operaci√≥n aritm√©tica<br>
                üìù <strong>Pregunta</strong> ‚Äî Responder con al menos 10 palabras
              </div>
            </div>`;
        }
      } catch {
        el.innerHTML = noServerHtml('ver la verificaci√≥n');
      }
    }

    // ‚îÄ‚îÄ‚îÄ Ranks Page ‚îÄ‚îÄ‚îÄ
    async function renderRanks() {
      const el = document.getElementById('ranks-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('manage ranks'); return; }

      el.innerHTML = '<div class="page-header"><h2>üèõÔ∏è Rangos Egipcios</h2><p>Loading...</p></div>';

      try {
        const [ranksRes, apiRes] = await Promise.all([
          fetch(`${API}/api/ranks/${currentGuild}`),
          fetch(`${API}/api/gameapi/${currentGuild}`)
        ]);
        const ranks = await ranksRes.json();
        const gameApi = await apiRes.json();

        let ranksHtml = '';
        if (ranks.length) {
          ranksHtml = ranks.map(r => {
            const color = typeof r.color === 'number' ? '#' + r.color.toString(16).padStart(6, '0') : (r.color || '#6d6d6d');
            const levelText = r.level === 0 ? 'Entry' : r.level === -1 ? 'Verified' : `Level ${r.level}+`;
            return `<tr>
              <td><span style="color:${color};font-weight:600">${r.name}</span></td>
              <td><code>${r.roleKey}</code></td>
              <td>${levelText}</td>
              <td><span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:${color};vertical-align:middle"></span> ${color}</td>
              <td>${r.description || '-'}</td>
              <td>${r.level > 0 ? `<div class="form-actions" style="margin:0"><input type="number" id="level-${r.roleKey}" value="${r.level}" style="width:70px;padding:4px 8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px"><button class="btn btn-ghost btn-sm" onclick="editRankLevel('${r.roleKey}')">Save</button></div>` : '-'}</td>
              <td>${r.level > 0 ? `<button class="btn btn-danger btn-sm" onclick="deleteRank('${r.roleKey}')">Delete</button>` : ''}</td>
            </tr>`;
          }).join('');
        } else {
          ranksHtml = '<tr><td colspan="7" style="text-align:center;color:var(--text-secondary)">No ranks configured</td></tr>';
        }

        el.innerHTML = `
          <div class="page-header"><h2>üèõÔ∏è Rangos Egipcios ‚Äî ${currentGuildData?.name || ''}</h2><p>Manage the Egyptian rank hierarchy</p></div>
          <div class="card">
            <h3>üìú Current Hierarchy</h3>
            <table>
              <thead><tr><th>Name</th><th>Key</th><th>Level</th><th>Color</th><th>Description</th><th>Edit Level</th><th>Actions</th></tr></thead>
              <tbody>${ranksHtml}</tbody>
            </table>
          </div>
          <div class="card">
            <h3>‚ûï Add New Rank</h3>
            <div class="form-grid">
              <div class="form-group"><label>Name (with emoji)</label><input type="text" id="rank-name" placeholder="e.g. ‚öîÔ∏è Warrior"></div>
              <div class="form-group"><label>Required Level</label><input type="number" id="rank-level" placeholder="e.g. 15" min="1"></div>
              <div class="form-group"><label>Color</label><input type="color" id="rank-color" value="#5865f2"></div>
              <div class="form-group"><label>Description</label><input type="text" id="rank-desc" placeholder="Short description"></div>
            </div>
            <div class="form-actions"><button class="btn btn-primary" onclick="addRank()">Add Rank</button></div>
          </div>
          <div class="card">
            <h3>üîå Game API Configuration</h3>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px">Configure the API that verifies player levels when claiming ranks via wallet</p>
            <div class="form-grid">
              <div class="form-group"><label>Base URL</label><input type="text" id="api-base-url" value="${gameApi.baseUrl || ''}" placeholder="https://api.tapkamun.fun"></div>
              <div class="form-group"><label>Endpoint <span style="color:var(--text-secondary);font-size:11px">({wallet} = placeholder)</span></label><input type="text" id="api-endpoint" value="${gameApi.endpoint || ''}" placeholder="/api/public/check/level/{wallet}"></div>
              <div class="form-group"><label>Level field in JSON response</label><input type="text" id="api-level-field" value="${gameApi.levelField || ''}" placeholder="level"></div>
              <div class="form-group"><label>API Key <span style="color:var(--text-secondary);font-size:11px">(optional)</span></label><input type="text" id="api-key" value="${gameApi.apiKey || ''}" placeholder="Leave empty if public"></div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" onclick="saveGameApi()">Save API Config</button>
              <button class="btn btn-ghost" onclick="testGameApi()">Test Connection</button>
            </div>
            <div id="api-test-result"></div>
          </div>
          <div class="info-box">
            <strong>Discord Commands:</strong><br>
            <code>/setuproles</code> ‚Äî Create all roles in Discord<br>
            <code>/setupclaim</code> ‚Äî Create the claim channel with buttons<br>
            <code>/ranks</code> ‚Äî Show the hierarchy in chat
          </div>`;
      } catch {
        el.innerHTML = '<div class="card"><p style="color:var(--red)">Error loading ranks</p></div>';
      }
    }

    async function addRank() {
      const name = document.getElementById('rank-name').value.trim();
      const level = document.getElementById('rank-level').value;
      const color = document.getElementById('rank-color').value;
      const description = document.getElementById('rank-desc').value.trim();
      if (!name || !level) return toast('Fill in name and level', true);

      try {
        const res = await fetch(`${API}/api/ranks/${currentGuild}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, level: parseInt(level), color, description })
        });
        if (res.ok) { toast('Rank added'); renderRanks(); }
        else toast('Error adding rank', true);
      } catch { toast('Error adding rank', true); }
    }

    async function editRankLevel(roleKey) {
      const input = document.getElementById(`level-${roleKey}`);
      if (!input) return;
      const newLevel = parseInt(input.value);
      if (isNaN(newLevel) || newLevel < 1) return toast('Invalid level', true);

      try {
        const ranksRes = await fetch(`${API}/api/ranks/${currentGuild}`);
        const ranks = await ranksRes.json();
        const rank = ranks.find(r => r.roleKey === roleKey);
        if (rank) rank.level = newLevel;
        const res = await fetch(`${API}/api/ranks/${currentGuild}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ranks })
        });
        if (res.ok) { toast('Level updated'); renderRanks(); }
        else toast('Error updating level', true);
      } catch { toast('Error updating level', true); }
    }

    async function deleteRank(roleKey) {
      if (!confirm('Delete this rank?')) return;
      try {
        const res = await fetch(`${API}/api/ranks/${currentGuild}/${roleKey}`, { method: 'DELETE' });
        if (res.ok) { toast('Rank deleted'); renderRanks(); }
        else toast('Error deleting rank', true);
      } catch { toast('Error deleting rank', true); }
    }

    async function saveGameApi() {
      const baseUrl = document.getElementById('api-base-url').value.trim();
      const endpoint = document.getElementById('api-endpoint').value.trim();
      const levelField = document.getElementById('api-level-field').value.trim();
      const apiKey = document.getElementById('api-key').value.trim();
      if (!baseUrl || !endpoint || !levelField) return toast('Fill in Base URL, Endpoint, and Level field', true);
      try {
        const res = await fetch(`${API}/api/gameapi/${currentGuild}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseUrl, endpoint, levelField, apiKey })
        });
        if (res.ok) toast('Game API config saved');
        else toast('Error saving API config', true);
      } catch { toast('Error saving API config', true); }
    }

    async function testGameApi() {
      const resultEl = document.getElementById('api-test-result');
      resultEl.innerHTML = '<span style="color:var(--text-secondary)">Testing via server...</span>';
      try {
        const res = await fetch(`${API}/api/gameapi/${currentGuild}/test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const result = await res.json();
        if (!res.ok) {
          resultEl.innerHTML = `<span style="color:var(--red)">‚ùå ${result.error}${result.url ? '<br><code style="font-size:11px">' + result.url + '</code>' : ''}</span>`;
          return;
        }
        const levelFound = result.levelValue !== null && result.levelValue !== undefined;
        resultEl.innerHTML = `<div style="margin-top:8px;padding:10px;background:var(--bg-primary);border-radius:8px;font-size:13px"><strong style="color:var(--green)">‚úÖ API responded (HTTP ${result.status})</strong><br><code style="font-size:11px">${result.url}</code><br><code style="font-size:12px">${JSON.stringify(result.data).slice(0, 300)}</code><br>Level field "<code>${result.levelField}</code>" = <strong>${levelFound ? result.levelValue : 'not found ‚ö†Ô∏è'}</strong></div>`;
      } catch (err) {
        resultEl.innerHTML = `<span style="color:var(--red)">‚ùå Connection failed: ${err.message}</span>`;
      }
    }

    // ‚îÄ‚îÄ‚îÄ Wallets Page ‚îÄ‚îÄ‚îÄ
    async function renderWallets() {
      const el = document.getElementById('wallets-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('view wallets'); return; }

      el.innerHTML = '<div class="page-header"><h2>üîó Wallets</h2><p>Loading...</p></div>';

      try {
        const res = await fetch(`${API}/api/wallets/${currentGuild}`);
        const wallets = await res.json();

        let walletsHtml = '';
        if (wallets.length) {
          walletsHtml = wallets.map(w => `<tr>
            <td><code>${w.userId}</code></td>
            <td><code style="color:var(--accent-light)">${w.wallet.slice(0, 6)}...${w.wallet.slice(-4)}</code></td>
            <td>${w.lastRank || '-'}</td>
            <td>${w.lastLevel !== undefined ? w.lastLevel : '-'}</td>
            <td>${w.lastClaim ? new Date(w.lastClaim).toLocaleString() : '-'}</td>
          </tr>`).join('');
        } else {
          walletsHtml = '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary)">No wallets linked yet</td></tr>';
        }

        el.innerHTML = `
          <div class="page-header"><h2>üîó Linked Wallets ‚Äî ${currentGuildData?.name || ''}</h2><p>Wallets verified through the claim system</p></div>
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-icon">üîó</div><div class="stat-value">${wallets.length}</div><div class="stat-label">Linked Wallets</div></div>
          </div>
          <div class="card">
            <h3>üìã Wallet Registry</h3>
            <table>
              <thead><tr><th>User ID</th><th>Wallet</th><th>Current Rank</th><th>Level</th><th>Last Claim</th></tr></thead>
              <tbody>${walletsHtml}</tbody>
            </table>
          </div>`;
      } catch {
        el.innerHTML = '<div class="card"><p style="color:var(--red)">Error loading wallets</p></div>';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Tickets Page ‚îÄ‚îÄ‚îÄ
    let ticketConfig = null;
    let ticketsList = {};

    function categoryOptions(selectedId) {
      if (!currentGuildData) return '<option value="">No server</option>';
      const cats = currentGuildData.channels.filter(c => c.type === 4);
      let html = '<option value="">Select category...</option>';
      cats.forEach(c => {
        html += `<option value="${c.id}" ${c.id === selectedId ? 'selected' : ''}>${c.name}</option>`;
      });
      return html;
    }

    function roleOptions(selectedId) {
      if (!currentGuildData) return '<option value="">No server</option>';
      let html = '<option value="">Select role...</option>';
      currentGuildData.roles.filter(r => r.name !== '@everyone').forEach(r => {
        html += `<option value="${r.id}" ${r.id === selectedId ? 'selected' : ''}>${r.name}</option>`;
      });
      return html;
    }

    async function renderTickets() {
      const el = document.getElementById('tickets-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('manage tickets'); return; }

      el.innerHTML = '<div class="page-header"><h2>üé´ Tickets</h2><p>Loading...</p></div>';

      try {
        const [configRes, listRes] = await Promise.all([
          fetch(`${API}/api/tickets/config/${currentGuild}`),
          fetch(`${API}/api/tickets/list/${currentGuild}`)
        ]);
        ticketConfig = await configRes.json();
        ticketsList = await listRes.json();
      } catch {
        el.innerHTML = '<div class="card"><p style="color:var(--red)">Error loading ticket data</p></div>';
        return;
      }

      const allTickets = Object.values(ticketsList);
      const openCount = allTickets.filter(t => t.status === 'open').length;
      const claimedCount = allTickets.filter(t => t.claimedBy && t.status !== 'closed').length;
      const closedCount = allTickets.filter(t => t.status === 'closed').length;

      // Types editor rows
      let typesHtml = '';
      if (ticketConfig.types && ticketConfig.types.length) {
        typesHtml = ticketConfig.types.map((t, i) => `
          <tr>
            <td><code>${t.id}</code></td>
            <td>${t.emoji} ${t.name}</td>
            <td>${t.description}</td>
            <td>${currentGuildData?.roles.find(r => r.id === t.handlerRoleId)?.name || t.handlerRoleId || '-'}</td>
            <td><span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:${t.color || '#5865f2'};vertical-align:middle"></span> ${t.color || '#5865f2'}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteTicketType('${t.id}')">Delete</button></td>
          </tr>`).join('');
      } else {
        typesHtml = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary)">No ticket types configured. Add one below.</td></tr>';
      }

      // Open tickets table
      const openTickets = allTickets.filter(t => t.status !== 'closed');
      let openTicketsHtml = '';
      if (openTickets.length) {
        openTicketsHtml = openTickets.map(t => `
          <tr>
            <td><code>#${t.ticketNumber}</code></td>
            <td>${t.typeName || t.typeId}</td>
            <td>${t.userTag}</td>
            <td><span class="badge ${t.claimedBy ? 'badge-yellow' : 'badge-green'}">${t.claimedBy ? 'Claimed' : 'Open'}</span></td>
            <td>${t.claimedByTag || '-'}</td>
            <td>${new Date(t.createdAt).toLocaleString()}</td>
          </tr>`).join('');
      } else {
        openTicketsHtml = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary)">No open tickets</td></tr>';
      }

      el.innerHTML = `
        <div class="page-header"><h2>üé´ Tickets ‚Äî ${currentGuildData?.name || ''}</h2><p>Configure and manage the ticket system</p></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon">üé´</div><div class="stat-value">${allTickets.length}</div><div class="stat-label">Total Tickets</div></div>
          <div class="stat-card"><div class="stat-icon">üì¨</div><div class="stat-value">${openCount}</div><div class="stat-label">Open</div></div>
          <div class="stat-card"><div class="stat-icon">üëã</div><div class="stat-value">${claimedCount}</div><div class="stat-label">Claimed</div></div>
          <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value">${closedCount}</div><div class="stat-label">Closed</div></div>
        </div>

        <div class="card">
          <h3>‚öôÔ∏è Panel Channel</h3>
          <div class="form-group">
            <label>Channel where the ticket panel will be posted</label>
            <select id="ticket-panel-channel">${channelOptions('text')}</select>
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" onclick="saveTicketConfig()">Save Config</button>
            <button class="btn btn-ghost" onclick="deployTicketPanel()" ${!ticketConfig.types.length ? 'disabled style="opacity:0.5"' : ''}>Deploy Panel</button>
          </div>
        </div>

        <div class="card">
          <h3>üìã Ticket Types</h3>
          <table>
            <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Handler Role</th><th>Color</th><th>Actions</th></tr></thead>
            <tbody>${typesHtml}</tbody>
          </table>
        </div>

        <div class="card">
          <h3>‚ûï Add Ticket Type</h3>
          <div class="form-grid">
            <div class="form-group"><label>Type ID</label><input type="text" id="tt-id" placeholder="e.g. support, collabs"></div>
            <div class="form-group"><label>Name</label><input type="text" id="tt-name" placeholder="e.g. Support"></div>
            <div class="form-group"><label>Emoji</label><input type="text" id="tt-emoji" placeholder="e.g. üé´"></div>
            <div class="form-group"><label>Color</label><input type="color" id="tt-color" value="#5865f2"></div>
            <div class="form-group"><label>Handler Role</label><select id="tt-role">${roleOptions()}</select></div>
          </div>
          <div class="form-group"><label>Description</label><input type="text" id="tt-desc" placeholder="Short description shown on the panel"></div>
          <div class="form-actions"><button class="btn btn-primary" onclick="addTicketType()">Add Type</button></div>
        </div>

        <div class="card">
          <h3>üì¨ Open Tickets</h3>
          <table>
            <thead><tr><th>#</th><th>Type</th><th>User</th><th>Status</th><th>Claimed by</th><th>Created</th></tr></thead>
            <tbody>${openTicketsHtml}</tbody>
          </table>
        </div>`;

      // Set panel channel value
      if (ticketConfig.panelChannelId) {
        document.getElementById('ticket-panel-channel').value = ticketConfig.panelChannelId;
      }
    }

    async function saveTicketConfig() {
      const panelChannelId = document.getElementById('ticket-panel-channel').value;
      if (!panelChannelId) return toast('Select a panel channel', true);
      try {
        const res = await fetch(`${API}/api/tickets/config/${currentGuild}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ panelChannelId })
        });
        if (res.ok) { toast('Ticket config saved'); renderTickets(); }
        else toast('Error saving config', true);
      } catch { toast('Error saving config', true); }
    }

    async function deployTicketPanel() {
      try {
        const res = await fetch(`${API}/api/tickets/deploy/${currentGuild}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await res.json();
        if (res.ok) toast(`Panel ${data.action}!`);
        else toast(data.error || 'Error deploying', true);
      } catch { toast('Error deploying panel', true); }
    }

    async function addTicketType() {
      const id = document.getElementById('tt-id').value.trim().toLowerCase().replace(/\s+/g, '-');
      const name = document.getElementById('tt-name').value.trim();
      const emoji = document.getElementById('tt-emoji').value.trim();
      const description = document.getElementById('tt-desc').value.trim();
      const handlerRoleId = document.getElementById('tt-role').value;
      const color = document.getElementById('tt-color').value;

      if (!id || !name || !emoji || !description || !handlerRoleId) return toast('Fill in all fields', true);

      const types = [...(ticketConfig.types || [])];
      const idx = types.findIndex(t => t.id === id);
      const typeData = { id, name, emoji, description, handlerRoleId, color };
      if (idx >= 0) types[idx] = typeData;
      else types.push(typeData);

      try {
        const res = await fetch(`${API}/api/tickets/config/${currentGuild}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ types })
        });
        if (res.ok) { toast(`Type "${name}" ${idx >= 0 ? 'updated' : 'added'}`); renderTickets(); }
        else toast('Error saving type', true);
      } catch { toast('Error saving type', true); }
    }

    async function deleteTicketType(typeId) {
      if (!confirm('Delete this ticket type?')) return;
      try {
        const res = await fetch(`${API}/api/tickets/type/${currentGuild}/${typeId}`, { method: 'DELETE' });
        if (res.ok) { toast('Type deleted'); renderTickets(); }
        else toast('Error deleting type', true);
      } catch { toast('Error deleting type', true); }
    }

    // ‚îÄ‚îÄ‚îÄ Setup Wizard ‚îÄ‚îÄ‚îÄ
    let wizardStep = 1;
    let wizardTemplates = null;
    let wizardData = { templateKey: null, categories: [], roles: [], deleteExisting: false, enableVerification: false, verifyType: 'puzzle', enableTickets: false, ticketTypes: [], ticketPanelChannelName: '' };

    async function renderSetupWizard() {
      const el = document.getElementById('setup-wizard-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('customize the server'); return; }

      // Load templates on first render
      if (!wizardTemplates) {
        try {
          const res = await fetch(`${API}/api/setup-templates`);
          wizardTemplates = await res.json();
        } catch { el.innerHTML = '<div class="card"><p style="color:var(--red)">Error loading templates</p></div>'; return; }
      }

      const stepLabels = ['Template', 'Channels', 'Roles', 'Options', 'Execute'];
      const stepsHtml = stepLabels.map((label, i) => {
        const n = i + 1;
        const cls = n === wizardStep ? 'active' : n < wizardStep ? 'done' : '';
        return `<div class="wizard-step ${cls}">${n}. ${label}</div>`;
      }).join('');

      let content = '';
      if (wizardStep === 1) content = renderWizardStep1();
      else if (wizardStep === 2) content = renderWizardStep2();
      else if (wizardStep === 3) content = renderWizardStep3();
      else if (wizardStep === 4) content = renderWizardStep4();
      else if (wizardStep === 5) content = renderWizardStep5();

      el.innerHTML = `
        <div class="page-header"><h2>üõ†Ô∏è Customize Server ‚Äî ${currentGuildData?.name || ''}</h2><p>Set up your server structure step by step</p></div>
        <div class="wizard-steps">${stepsHtml}</div>
        ${content}`;
    }

    function renderWizardStep1() {
      const icons = { gaming: 'üéÆ', community: 'üåç', business: 'üíº', web3: 'üåê' };
      let cards = '';
      for (const [key, tpl] of Object.entries(wizardTemplates)) {
        const selected = wizardData.templateKey === key ? 'selected' : '';
        cards += `<div class="template-card ${selected}" onclick="selectTemplate('${key}')">
          <div class="tpl-icon">${icons[key] || 'üì¶'}</div>
          <div class="tpl-name">${tpl.name}</div>
          <div class="tpl-stats">${tpl.totalCategories} categories ¬∑ ${tpl.totalChannels} channels ¬∑ ${tpl.totalRoles} roles</div>
        </div>`;
      }
      return `<div class="template-cards">${cards}</div>
        <div class="wizard-nav"><div></div><button class="btn btn-primary" onclick="wizardNext()" ${!wizardData.templateKey ? 'disabled style="opacity:0.5"' : ''}>Next ‚Üí</button></div>`;
    }

    function selectTemplate(key) {
      wizardData.templateKey = key;
      const tpl = wizardTemplates[key];
      wizardData.categories = JSON.parse(JSON.stringify(tpl.categories.map(cat => ({ ...cat, enabled: true, channels: cat.channels.map(ch => ({ ...ch, enabled: true })) }))));
      wizardData.roles = JSON.parse(JSON.stringify(tpl.roles.map(r => ({ ...r, enabled: true }))));
      renderSetupWizard();
    }

    function renderWizardStep2() {
      if (!wizardData.categories.length) return '<p>Select a template first</p>';
      let html = '';
      wizardData.categories.forEach((cat, ci) => {
        let channels = '';
        cat.channels.forEach((ch, chi) => {
          const icon = ch.type === 'voice' ? 'üîä' : ch.type === 'announcement' ? 'üì¢' : '#';
          channels += `<div class="toggle-row">
            <label><input type="checkbox" ${ch.enabled ? 'checked' : ''} onchange="wizardData.categories[${ci}].channels[${chi}].enabled=this.checked"> ${icon} ${ch.name}</label>
            <input type="text" value="${ch.name}" onchange="wizardData.categories[${ci}].channels[${chi}].name=this.value" placeholder="Name">
          </div>`;
        });
        html += `<div class="category-block">
          <div class="category-header"><input type="checkbox" ${cat.enabled ? 'checked' : ''} onchange="wizardData.categories[${ci}].enabled=this.checked;renderSetupWizard()"> ${cat.name}</div>
          ${cat.enabled ? channels : '<div style="padding:8px 12px;color:var(--text-secondary);font-size:13px">Category disabled</div>'}
        </div>`;
      });
      return `<div class="card">${html}</div>
        <div class="wizard-nav"><button class="btn btn-ghost" onclick="wizardPrev()">‚Üê Back</button><button class="btn btn-primary" onclick="wizardNext()">Next ‚Üí</button></div>`;
    }

    function renderWizardStep3() {
      if (!wizardData.roles.length) return '<p>Select a template first</p>';
      let html = '';
      wizardData.roles.forEach((r, ri) => {
        const color = typeof r.color === 'number' ? '#' + r.color.toString(16).padStart(6, '0') : r.color;
        html += `<div class="toggle-row">
          <label><input type="checkbox" ${r.enabled ? 'checked' : ''} onchange="wizardData.roles[${ri}].enabled=this.checked"> <span class="role-color-dot" style="background:${color}"></span> ${r.name}</label>
          <input type="text" value="${r.name}" onchange="wizardData.roles[${ri}].name=this.value" placeholder="Role name">
        </div>`;
      });
      return `<div class="card"><h3>üé≠ Roles</h3>${html}</div>
        <div class="wizard-nav"><button class="btn btn-ghost" onclick="wizardPrev()">‚Üê Back</button><button class="btn btn-primary" onclick="wizardNext()">Next ‚Üí</button></div>`;
    }

    function renderWizardStep4() {
      return `
        <div class="card">
          <h3>‚öôÔ∏è Additional Options</h3>
          <div class="toggle-row">
            <label><input type="checkbox" ${wizardData.deleteExisting ? 'checked' : ''} onchange="wizardData.deleteExisting=this.checked;renderSetupWizard()"> Delete existing channels before creating</label>
          </div>
          ${wizardData.deleteExisting ? '<div class="warning-box">‚ö†Ô∏è <strong>Warning:</strong> This will delete ALL current channels and categories from the server. This action is irreversible.</div>' : ''}
          <div class="toggle-row" style="margin-top:12px">
            <label><input type="checkbox" ${wizardData.enableVerification ? 'checked' : ''} onchange="wizardData.enableVerification=this.checked;renderSetupWizard()"> Enable verification system</label>
          </div>
          ${wizardData.enableVerification ? `
            <div style="padding:12px;margin-top:8px">
              <div class="form-group">
                <label>Verification type</label>
                <select onchange="wizardData.verifyType=this.value" style="width:100%;padding:10px 14px;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:14px">
                  <option value="puzzle" ${wizardData.verifyType==='puzzle'?'selected':''}>üß© Puzzle ‚Äî Solve a riddle</option>
                  <option value="colors" ${wizardData.verifyType==='colors'?'selected':''}>üé® Colors ‚Äî Emoji sequence</option>
                  <option value="math" ${wizardData.verifyType==='math'?'selected':''}>üî¢ Math ‚Äî Solve an equation</option>
                  <option value="question" ${wizardData.verifyType==='question'?'selected':''}>üìù Question ‚Äî Free response</option>
                </select>
              </div>
            </div>` : ''}
          <div class="toggle-row" style="margin-top:12px">
            <label><input type="checkbox" ${wizardData.enableTickets ? 'checked' : ''} onchange="wizardData.enableTickets=this.checked;renderSetupWizard()"> Deploy ticket panel</label>
          </div>
          ${wizardData.enableTickets ? renderWizardTicketConfig() : ''}
        </div>
        <div class="wizard-nav"><button class="btn btn-ghost" onclick="wizardPrev()">‚Üê Back</button><button class="btn btn-primary" onclick="wizardNext()">Review ‚Üí</button></div>`;
    }

    function renderWizardTicketConfig() {
      // Build channel options from enabled template categories/channels (text only, not staff)
      const channelNames = [];
      wizardData.categories.filter(c => c.enabled).forEach(cat => {
        cat.channels.filter(ch => ch.enabled && ch.type !== 'voice' && !ch.staffOnly).forEach(ch => {
          channelNames.push(ch.name);
        });
      });
      const channelOpts = channelNames.map(n => `<option value="${n}" ${wizardData.ticketPanelChannelName === n ? 'selected' : ''}>${n}</option>`).join('');

      // Build role options from enabled roles
      const roleNames = wizardData.roles.filter(r => r.enabled).map(r => r.name);
      const roleOpts = roleNames.map(n => `<option value="${n}">${n}</option>`).join('');

      // Existing ticket types list
      let typesHtml = '';
      if (wizardData.ticketTypes.length) {
        typesHtml = '<div style="margin-bottom:12px">' + wizardData.ticketTypes.map((t, i) => `
          <div class="toggle-row">
            <label>${t.emoji} <strong>${t.name}</strong> ‚Äî ${t.description} <span style="color:var(--text-secondary);font-size:12px">(${t.handlerRoleName})</span></label>
            <button class="btn btn-danger btn-sm" onclick="removeWizardTicketType(${i})">Remove</button>
          </div>`).join('') + '</div>';
      }

      return `
        <div style="padding:12px;margin-top:8px">
          <div class="form-group">
            <label>Panel channel (where the ticket panel will appear)</label>
            <select onchange="wizardData.ticketPanelChannelName=this.value" style="width:100%;padding:10px 14px;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:14px">
              <option value="">Select channel...</option>
              ${channelOpts}
            </select>
          </div>
          ${typesHtml}
          <div style="background:var(--bg-primary);border:1px solid var(--border);border-radius:10px;padding:16px;margin-top:8px">
            <div style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--accent-light)">‚ûï Add Ticket Type</div>
            <div class="form-grid">
              <div class="form-group"><label>Name</label><input type="text" id="wiz-tt-name" placeholder="e.g. Support"></div>
              <div class="form-group"><label>Emoji</label><input type="text" id="wiz-tt-emoji" placeholder="e.g. üé´" style="width:80px"></div>
              <div class="form-group"><label>Handler role</label>
                <select id="wiz-tt-role" style="width:100%;padding:10px 14px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:14px">
                  <option value="">Select role...</option>${roleOpts}
                </select>
              </div>
              <div class="form-group"><label>Color</label><input type="color" id="wiz-tt-color" value="#5865f2"></div>
            </div>
            <div class="form-group"><label>Description</label><input type="text" id="wiz-tt-desc" placeholder="Short description shown on the panel"></div>
            <button class="btn btn-ghost" onclick="addWizardTicketType()">Add Type</button>
          </div>
        </div>`;
    }

    function addWizardTicketType() {
      const name = document.getElementById('wiz-tt-name')?.value.trim();
      const emoji = document.getElementById('wiz-tt-emoji')?.value.trim();
      const description = document.getElementById('wiz-tt-desc')?.value.trim();
      const handlerRoleName = document.getElementById('wiz-tt-role')?.value;
      const color = document.getElementById('wiz-tt-color')?.value || '#5865f2';

      if (!name || !emoji || !description || !handlerRoleName) {
        return toast('Fill in all ticket type fields', true);
      }

      const id = name.toLowerCase().replace(/\s+/g, '-');
      wizardData.ticketTypes.push({ id, name, emoji, description, handlerRoleName, color });
      renderSetupWizard();
    }

    function removeWizardTicketType(index) {
      wizardData.ticketTypes.splice(index, 1);
      renderSetupWizard();
    }

    function renderWizardStep5() {
      const tpl = wizardTemplates[wizardData.templateKey];
      const enabledCats = wizardData.categories.filter(c => c.enabled);
      const enabledChannels = enabledCats.reduce((acc, c) => acc + c.channels.filter(ch => ch.enabled).length, 0);
      const enabledRoles = wizardData.roles.filter(r => r.enabled);

      let catsList = enabledCats.map(c => {
        const chs = c.channels.filter(ch => ch.enabled).map(ch => `<li>${ch.type === 'voice' ? 'üîä' : '#'} ${ch.name}</li>`).join('');
        return `<li><strong>${c.name}</strong><ul>${chs}</ul></li>`;
      }).join('');

      let rolesList = enabledRoles.map(r => {
        const color = typeof r.color === 'number' ? '#' + r.color.toString(16).padStart(6, '0') : r.color;
        return `<li><span class="role-color-dot" style="background:${color}"></span> ${r.name}</li>`;
      }).join('');

      return `
        <div class="card">
          <h3>üìã Summary</h3>
          <div class="info-box">Template: <strong>${tpl.name}</strong> ¬∑ ${enabledCats.length} categories ¬∑ ${enabledChannels} channels ¬∑ ${enabledRoles.length} roles
            ${wizardData.deleteExisting ? ' ¬∑ <span style="color:var(--yellow)">Delete existing</span>' : ''}
            ${wizardData.enableVerification ? ` ¬∑ Verification (${wizardData.verifyType})` : ''}
            ${wizardData.enableTickets ? ` ¬∑ Tickets (${wizardData.ticketTypes.length} types)` : ''}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div class="review-section"><h4>üìÅ Categories & Channels</h4><ul class="review-list">${catsList}</ul></div>
            <div class="review-section"><h4>üé≠ Roles</h4><ul class="review-list">${rolesList}</ul></div>
          </div>
        </div>
        <div id="wizard-progress" style="display:none">
          <div class="card">
            <h3>‚öôÔ∏è Setting up server...</h3>
            <div class="progress-log" id="wizard-log"></div>
          </div>
        </div>
        <div class="wizard-nav" id="wizard-exec-nav">
          <button class="btn btn-ghost" onclick="wizardPrev()">‚Üê Back</button>
          <button class="btn btn-primary" onclick="executeWizard()" id="wizard-exec-btn">üöÄ Create Server</button>
        </div>`;
    }

    function wizardNext() {
      if (wizardStep === 1 && !wizardData.templateKey) return;
      if (wizardStep < 5) { wizardStep++; renderSetupWizard(); }
    }
    function wizardPrev() {
      if (wizardStep > 1) { wizardStep--; renderSetupWizard(); }
    }

    async function executeWizard() {
      const btn = document.getElementById('wizard-exec-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      document.getElementById('wizard-progress').style.display = 'block';
      document.getElementById('wizard-exec-nav').style.display = 'none';
      const log = document.getElementById('wizard-log');

      const addLog = (msg, cls) => {
        const line = document.createElement('div');
        line.className = 'log-line' + (cls ? ` ${cls}` : '');
        line.textContent = msg;
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
      };

      addLog('Starting server setup...');

      try {
        const body = {
          guildId: currentGuild,
          templateKey: wizardData.templateKey,
          deleteExisting: wizardData.deleteExisting,
          categories: wizardData.categories.filter(c => c.enabled).map(c => ({
            ...c, channels: c.channels.filter(ch => ch.enabled)
          })),
          roles: wizardData.roles.filter(r => r.enabled),
          enableVerification: wizardData.enableVerification,
          verifyType: wizardData.verifyType,
        };

        const res = await fetch(`${API}/api/setup-server`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            try {
              const data = JSON.parse(line.slice(6));
              if (data.type === 'progress') addLog(data.message);
              else if (data.type === 'complete') { addLog(data.message, 'success'); addLog('--- Setup complete ---', 'success'); }
              else if (data.type === 'error') addLog('ERROR: ' + data.message, 'error');
            } catch {}
          }
        }

        // Refresh guild data
        try {
          const gRes = await fetch(`${API}/api/guilds/${currentGuild}`);
          currentGuildData = await gRes.json();
        } catch {}

        // Deploy ticket panel if enabled
        if (wizardData.enableTickets && wizardData.ticketTypes.length) {
          addLog('Configuring ticket system...');
          try {
            // Resolve channel/category/role names to IDs from refreshed guild data
            const findChannelByName = (name) => currentGuildData?.channels?.find(c => c.name.replace(/^[^\w]*/, '').toLowerCase().includes(name.replace(/^[^\w]*/, '').toLowerCase()));
            const findRoleByName = (name) => currentGuildData?.roles?.find(r => r.name === name);

            // Find panel channel
            const panelCh = findChannelByName(wizardData.ticketPanelChannelName);
            if (!panelCh) {
              addLog('Ticket panel: Could not find panel channel "' + wizardData.ticketPanelChannelName + '"', 'error');
            } else {
              // Build ticket types with resolved IDs (categories are auto-created on deploy)
              const resolvedTypes = [];
              for (const t of wizardData.ticketTypes) {
                const role = findRoleByName(t.handlerRoleName);
                if (!role) { addLog(`Ticket type "${t.name}": role "${t.handlerRoleName}" not found, skipping`, 'error'); continue; }
                resolvedTypes.push({
                  id: t.id,
                  name: t.name,
                  emoji: t.emoji,
                  description: t.description,
                  handlerRoleId: role.id,
                  color: t.color,
                });
              }

              if (resolvedTypes.length) {
                // Save ticket config
                await fetch(`${API}/api/tickets/config/${currentGuild}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ panelChannelId: panelCh.id, types: resolvedTypes }),
                });
                addLog(`Ticket config saved (${resolvedTypes.length} types)`);

                // Deploy the panel
                addLog('Deploying ticket panel...');
                const ticketRes = await fetch(`${API}/api/tickets/deploy/${currentGuild}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                const ticketData = await ticketRes.json();
                if (ticketRes.ok) {
                  addLog(`Ticket panel ${ticketData.action}!`, 'success');
                } else {
                  addLog('Ticket panel: ' + (ticketData.error || 'Deploy failed'), 'error');
                }
              } else {
                addLog('No ticket types resolved ‚Äî skipping deploy', 'error');
              }
            }
          } catch (err) {
            addLog('Ticket setup error: ' + err.message, 'error');
          }
        }

        // Show restart button
        const nav = document.getElementById('wizard-exec-nav');
        nav.style.display = 'flex';
        nav.innerHTML = '<button class="btn btn-ghost" onclick="wizardStep=1;wizardData={templateKey:null,categories:[],roles:[],deleteExisting:false,enableVerification:false,verifyType:\'puzzle\',enableTickets:false,ticketTypes:[],ticketPanelChannelName:\'\'};renderSetupWizard()">üîÑ New Setup</button><button class="btn btn-primary" onclick="showPage(\'server-info\')">View Server ‚Üí</button>';
      } catch (err) {
        addLog('Connection error: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'üöÄ Retry';
        document.getElementById('wizard-exec-nav').style.display = 'flex';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ
    function toast(msg, isError) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      if (isError) el.style.borderColor = 'var(--red)';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // ‚îÄ‚îÄ‚îÄ Auto-refresh ‚îÄ‚îÄ‚îÄ
    setInterval(() => {
      if (document.getElementById('app').style.display !== 'none') loadDashboard();
    }, 30000);

    checkAuth();
  </script>
</body>
</html>
