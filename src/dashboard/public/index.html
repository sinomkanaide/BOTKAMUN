<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¤– Bot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a26;
      --bg-hover: #22222f;
      --accent: #6c5ce7;
      --accent-glow: rgba(108, 92, 231, 0.3);
      --accent-light: #a29bfe;
      --green: #00d2a0;
      --red: #ff6b6b;
      --yellow: #ffd93d;
      --text-primary: #e8e8ed;
      --text-secondary: #8888a0;
      --border: rgba(255,255,255,0.06);
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€â”€ Login Screen â”€â”€â”€ */
    #login-screen {
      display: flex; align-items: center; justify-content: center; min-height: 100vh;
      background: radial-gradient(ellipse at 50% 0%, rgba(108,92,231,0.15) 0%, transparent 60%);
    }
    .login-box {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px;
      padding: 48px; width: 380px; text-align: center;
    }
    .login-box h1 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
    .login-box p { color: var(--text-secondary); margin-bottom: 32px; }
    .error-msg { color: var(--red); font-size: 13px; margin-top: 8px; display: none; }

    /* â”€â”€â”€ Buttons â”€â”€â”€ */
    .btn {
      padding: 12px 24px; border-radius: 10px; border: none; font-family: inherit;
      font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: white; width: 100%; }
    .btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 4px 20px var(--accent-glow); }
    .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-danger { background: var(--red); color: white; }
    .btn-danger:hover { opacity: 0.9; }
    .btn-sm { padding: 6px 14px; font-size: 12px; }

    /* â”€â”€â”€ App Layout â”€â”€â”€ */
    #app { display: none; }
    .sidebar {
      position: fixed; left: 0; top: 0; width: 250px; height: 100vh;
      background: var(--bg-secondary); border-right: 1px solid var(--border);
      padding: 20px 14px; display: flex; flex-direction: column; z-index: 100;
      overflow-y: auto;
    }
    .sidebar-brand { display: flex; align-items: center; gap: 12px; padding: 0 8px; margin-bottom: 20px; }
    .sidebar-brand img { width: 40px; height: 40px; border-radius: 50%; }
    .sidebar-brand .brand-name { font-weight: 700; font-size: 15px; }
    .sidebar-brand .brand-status { font-size: 11px; color: var(--green); }

    /* Server selector */
    .server-selector { margin-bottom: 20px; padding: 0 4px; }
    .server-selector label { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 6px; padding: 0 4px; }
    .server-selector select {
      width: 100%; padding: 9px 12px; background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 13px; cursor: pointer;
    }
    .server-selector select:focus { outline: none; border-color: var(--accent); }

    .nav-section { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; padding: 0 8px; margin: 16px 0 6px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 9px 12px; border-radius: 8px;
      cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-secondary); transition: all 0.15s;
    }
    .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active { background: var(--accent); color: white; }
    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
    .sidebar-footer { margin-top: auto; padding-top: 12px; border-top: 1px solid var(--border); }

    .main {
      margin-left: 250px; padding: 32px; min-height: 100vh;
      background: radial-gradient(ellipse at 80% 0%, rgba(108,92,231,0.06) 0%, transparent 50%);
    }
    .page-header { margin-bottom: 28px; }
    .page-header h2 { font-size: 24px; font-weight: 800; }
    .page-header p { color: var(--text-secondary); margin-top: 4px; }

    /* â”€â”€â”€ Stats Cards â”€â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px; transition: all 0.2s;
    }
    .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
    .stat-card .stat-icon { font-size: 28px; margin-bottom: 12px; }
    .stat-card .stat-value { font-size: 28px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
    .stat-card .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

    /* â”€â”€â”€ Cards â”€â”€â”€ */
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; }
    .card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

    /* â”€â”€â”€ Tables â”€â”€â”€ */
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 10px 12px; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
    td { padding: 12px; font-size: 14px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--bg-hover); }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-green { background: rgba(0,210,160,0.15); color: var(--green); }
    .badge-red { background: rgba(255,107,107,0.15); color: var(--red); }
    .badge-yellow { background: rgba(255,217,61,0.15); color: var(--yellow); }
    .badge-purple { background: rgba(108,92,231,0.15); color: var(--accent-light); }

    /* â”€â”€â”€ Forms â”€â”€â”€ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 14px;
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
    .form-actions { display: flex; gap: 8px; margin-top: 8px; }

    /* â”€â”€â”€ Channel tree â”€â”€â”€ */
    .channel-tree { padding: 0; }
    .channel-category { margin-bottom: 12px; }
    .channel-category-name { font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .channel-item { padding: 6px 8px 6px 24px; font-size: 14px; color: var(--text-secondary); border-radius: 4px; display: flex; align-items: center; gap: 6px; }
    .channel-item:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* â”€â”€â”€ Info box â”€â”€â”€ */
    .info-box { background: rgba(108,92,231,0.08); border: 1px solid rgba(108,92,231,0.2); border-radius: 10px; padding: 16px 20px; margin-bottom: 20px; font-size: 14px; color: var(--text-secondary); }
    .info-box strong { color: var(--text-primary); }

    /* â”€â”€â”€ Config items â”€â”€â”€ */
    .config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .config-item:last-child { border-bottom: none; }
    .config-label { font-size: 13px; color: var(--text-secondary); }
    .config-value { font-size: 14px; font-weight: 600; }

    /* â”€â”€â”€ Pages â”€â”€â”€ */
    .page { display: none; }
    .page.active { display: block; }
    .no-server { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .no-server .no-server-icon { font-size: 48px; margin-bottom: 16px; }
    .no-server p { font-size: 15px; }

    /* â”€â”€â”€ Toast â”€â”€â”€ */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 20px; background: var(--bg-card); border: 1px solid var(--green); border-radius: 10px; font-size: 14px; z-index: 1000; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* â”€â”€â”€ Wizard â”€â”€â”€ */
    .wizard-steps { display: flex; gap: 4px; margin-bottom: 28px; }
    .wizard-step {
      flex: 1; padding: 10px; text-align: center; font-size: 12px; font-weight: 600;
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
      color: var(--text-secondary); transition: all 0.2s;
    }
    .wizard-step.active { background: var(--accent); color: white; border-color: var(--accent); }
    .wizard-step.done { background: rgba(0,210,160,0.15); color: var(--green); border-color: rgba(0,210,160,0.3); }
    .wizard-nav { display: flex; justify-content: space-between; margin-top: 24px; }
    .template-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .template-card {
      background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius);
      padding: 24px; cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .template-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .template-card.selected { border-color: var(--accent); background: rgba(108,92,231,0.1); }
    .template-card .tpl-icon { font-size: 40px; margin-bottom: 12px; }
    .template-card .tpl-name { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
    .template-card .tpl-stats { font-size: 12px; color: var(--text-secondary); }
    .toggle-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; border-radius: 8px; margin-bottom: 4px; transition: background 0.15s;
    }
    .toggle-row:hover { background: var(--bg-hover); }
    .toggle-row label { font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .toggle-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
    .toggle-row input[type="text"] {
      background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text-primary); padding: 4px 8px; font-size: 13px; font-family: inherit; width: 200px;
    }
    .toggle-row input[type="text"]:focus { outline: none; border-color: var(--accent); }
    .category-block { margin-bottom: 16px; }
    .category-header { font-size: 13px; font-weight: 700; color: var(--accent-light); margin-bottom: 6px; padding: 8px 12px; background: rgba(108,92,231,0.08); border-radius: 8px; display: flex; align-items: center; gap: 8px; }
    .role-color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
    .progress-log {
      background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px;
      padding: 16px; max-height: 400px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 13px;
    }
    .progress-log .log-line { padding: 3px 0; color: var(--text-secondary); }
    .progress-log .log-line.success { color: var(--green); }
    .progress-log .log-line.error { color: var(--red); }
    .warning-box { background: rgba(255,217,61,0.1); border: 1px solid rgba(255,217,61,0.3); border-radius: 10px; padding: 14px 18px; font-size: 13px; color: var(--yellow); margin-bottom: 16px; }
    .review-section { margin-bottom: 16px; }
    .review-section h4 { font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 8px; }
    .review-list { padding-left: 20px; font-size: 13px; color: var(--text-secondary); }
    .review-list li { padding: 2px 0; }

    /* â”€â”€â”€ Responsive â”€â”€â”€ */
    @media (max-width: 768px) {
      .sidebar { width: 60px; padding: 16px 8px; }
      .sidebar .brand-name, .sidebar .brand-status, .sidebar .nav-section, .sidebar .nav-item span:not(.icon), .server-selector { display: none; }
      .main { margin-left: 60px; padding: 16px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-box">
      <h1>ğŸ¤– Bot Panel</h1>
      <p>Inicia sesiÃ³n con tu cuenta de Discord</p>
      <div class="error-msg" id="login-error"></div>
      <a href="/api/auth/discord" class="btn btn-primary" style="margin-top:12px;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;width:100%">
        <svg width="20" height="15" viewBox="0 0 71 55" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M60.1 4.9A58.5 58.5 0 0 0 45.4.2a.2.2 0 0 0-.2.1 40.8 40.8 0 0 0-1.8 3.7 54 54 0 0 0-16.2 0A37.4 37.4 0 0 0 25.4.3a.2.2 0 0 0-.2-.1A58.4 58.4 0 0 0 10.5 5a.2.2 0 0 0-.1 0C1.5 18 -.9 30.6.3 43a.2.2 0 0 0 .1.2 58.7 58.7 0 0 0 17.7 9 .2.2 0 0 0 .3-.1 42 42 0 0 0 3.6-5.9.2.2 0 0 0-.1-.3 38.7 38.7 0 0 1-5.5-2.6.2.2 0 0 1 0-.4l1.1-.9a.2.2 0 0 1 .2 0 41.9 41.9 0 0 0 35.6 0 .2.2 0 0 1 .2 0l1.1.9a.2.2 0 0 1 0 .3c-1.8 1-3.6 1.8-5.5 2.7a.2.2 0 0 0-.1.3 47.2 47.2 0 0 0 3.6 5.8.2.2 0 0 0 .3.1A58.5 58.5 0 0 0 70.2 43a.2.2 0 0 0 .1-.2c1.4-14.7-2.4-27.4-10.1-38.7a.2.2 0 0 0-.1-.1zM23.7 35.3c-3.4 0-6.1-3.1-6.1-6.9s2.7-6.9 6.1-6.9 6.2 3.1 6.1 6.9c0 3.8-2.7 6.9-6.1 6.9zm22.6 0c-3.4 0-6.1-3.1-6.1-6.9s2.7-6.9 6.1-6.9 6.2 3.1 6.1 6.9c0 3.8-2.7 6.9-6.1 6.9z"/></svg>
        Iniciar sesiÃ³n con Discord
      </a>
      <a href="/api/bot/invite" target="_blank" class="btn btn-ghost" style="margin-top:10px;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;width:100%">
        <span>â•</span> AÃ±adir bot a un servidor
      </a>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <nav class="sidebar">
      <div class="sidebar-brand">
        <img id="bot-avatar" src="" alt="Bot">
        <div>
          <div class="brand-name" id="bot-name">Bot</div>
          <div class="brand-status">â— Online</div>
        </div>
      </div>

      <!-- Server Selector -->
      <div class="server-selector">
        <label>Servidor</label>
        <select id="guild-select" onchange="onGuildSelect()">
          <option value="">Selecciona un servidor...</option>
        </select>
      </div>

      <div class="nav-section">Principal</div>
      <div class="nav-item active" data-page="overview" onclick="showPage('overview')">
        <span class="icon">ğŸ“Š</span><span>Overview</span>
      </div>

      <div class="nav-section">GestiÃ³n del servidor</div>
      <div class="nav-item" data-page="server-info" onclick="showPage('server-info')">
        <span class="icon">ğŸ </span><span>Info & Canales</span>
      </div>
      <div class="nav-item" data-page="announcements" onclick="showPage('announcements')">
        <span class="icon">ğŸ“¢</span><span>Anuncios</span>
      </div>
      <div class="nav-item" data-page="messages" onclick="showPage('messages')">
        <span class="icon">ğŸ’¬</span><span>Enviar Mensaje</span>
      </div>
      <div class="nav-item" data-page="warnings-page" onclick="showPage('warnings-page')">
        <span class="icon">âš ï¸</span><span>Advertencias</span>
      </div>
      <div class="nav-item" data-page="verification" onclick="showPage('verification')">
        <span class="icon">ğŸ”</span><span>VerificaciÃ³n</span>
      </div>
      <div class="nav-item" data-page="setup-wizard" onclick="showPage('setup-wizard')">
        <span class="icon">ğŸ› ï¸</span><span>Personalizar</span>
      </div>

      <div class="sidebar-footer">
        <a href="/api/bot/invite" target="_blank" class="nav-item" style="text-decoration:none;color:inherit">
          <span class="icon">â•</span><span>AÃ±adir a servidor</span>
        </a>
        <div class="nav-item" onclick="logout()">
          <span class="icon">ğŸšª</span><span>Cerrar sesiÃ³n</span>
        </div>
      </div>
    </nav>

    <div class="main">

      <!-- OVERVIEW PAGE -->
      <div class="page active" id="page-overview">
        <div class="page-header">
          <h2>Dashboard</h2>
          <p>Vista general del bot</p>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon">ğŸ </div><div class="stat-value" id="stat-guilds">-</div><div class="stat-label">Servidores</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="stat-members">-</div><div class="stat-label">Miembros totales</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ’¬</div><div class="stat-value" id="stat-channels">-</div><div class="stat-label">Canales</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ“¡</div><div class="stat-value" id="stat-ping">-</div><div class="stat-label">Latencia (ms)</div></div>
          <div class="stat-card"><div class="stat-icon">â±ï¸</div><div class="stat-value" id="stat-uptime">-</div><div class="stat-label">Uptime</div></div>
        </div>
        <div class="card">
          <h3>ğŸ“… Anuncios Programados</h3>
          <table>
            <thead><tr><th>ID</th><th>TÃ­tulo</th><th>Frecuencia</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="overview-announcements"></tbody>
          </table>
        </div>
      </div>

      <!-- SERVER INFO PAGE -->
      <div class="page" id="page-server-info">
        <div id="server-info-content"></div>
      </div>

      <!-- ANNOUNCEMENTS PAGE -->
      <div class="page" id="page-announcements">
        <div id="announcements-content"></div>
      </div>

      <!-- MESSAGES PAGE -->
      <div class="page" id="page-messages">
        <div id="messages-content"></div>
      </div>

      <!-- WARNINGS PAGE -->
      <div class="page" id="page-warnings-page">
        <div id="warnings-content"></div>
      </div>

      <!-- VERIFICATION PAGE -->
      <div class="page" id="page-verification">
        <div id="verification-content"></div>
      </div>

      <!-- SETUP WIZARD PAGE -->
      <div class="page" id="page-setup-wizard">
        <div id="setup-wizard-content"></div>
      </div>

    </div>
  </div>

  <script>
    const API = '';
    let currentGuild = null;
    let currentGuildData = null;
    let allGuilds = [];

    // â”€â”€â”€ Auth â”€â”€â”€
    async function checkAuth() {
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      if (error) {
        const el = document.getElementById('login-error');
        const msgs = { unauthorized: 'Tu cuenta de Discord no tiene acceso a este panel.', token_failed: 'Error al autenticar con Discord. Intenta de nuevo.', no_code: 'Error en el proceso de login. Intenta de nuevo.', server_error: 'Error del servidor. Intenta de nuevo.' };
        el.textContent = msgs[error] || 'Error desconocido';
        el.style.display = 'block';
        window.history.replaceState({}, '', '/');
      }
      try {
        const res = await fetch(`${API}/api/auth-check`);
        const data = await res.json();
        if (data.authenticated) {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          loadDashboard();
        }
      } catch {}
    }

    async function logout() {
      await fetch(`${API}/api/logout`, { method: 'POST' });
      location.reload();
    }

    // â”€â”€â”€ Navigation â”€â”€â”€
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item[data-page]').forEach(n => n.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');
      const navItem = document.querySelector(`[data-page="${page}"]`);
      if (navItem) navItem.classList.add('active');

      if (page === 'server-info') renderServerInfo();
      if (page === 'announcements') renderAnnouncements();
      if (page === 'messages') renderMessages();
      if (page === 'warnings-page') renderWarnings();
      if (page === 'verification') renderVerification();
      if (page === 'setup-wizard') renderSetupWizard();
    }

    function noServerHtml(action) {
      return `<div class="no-server"><div class="no-server-icon">ğŸ </div><p>Selecciona un servidor en el panel izquierdo para ${action}</p></div>`;
    }

    // â”€â”€â”€ Load Dashboard â”€â”€â”€
    async function loadDashboard() {
      try {
        const [statsRes, guildsRes] = await Promise.all([
          fetch(`${API}/api/stats`),
          fetch(`${API}/api/guilds`)
        ]);
        const stats = await statsRes.json();
        allGuilds = await guildsRes.json();

        document.getElementById('bot-name').textContent = stats.botName || 'Bot';
        document.getElementById('bot-avatar').src = stats.botAvatar || '';
        document.getElementById('stat-guilds').textContent = stats.guilds || 0;
        document.getElementById('stat-members').textContent = (stats.members || 0).toLocaleString();
        document.getElementById('stat-channels').textContent = stats.channels || 0;
        document.getElementById('stat-ping').textContent = stats.ping || '-';
        const uptime = stats.uptime || 0;
        document.getElementById('stat-uptime').textContent = `${Math.floor(uptime / 3600)}h ${Math.floor((uptime % 3600) / 60)}m`;

        // Populate server selector
        const select = document.getElementById('guild-select');
        const prevVal = select.value;
        select.innerHTML = '<option value="">Selecciona un servidor...</option>';
        allGuilds.forEach(g => {
          select.innerHTML += `<option value="${g.id}">${g.name} (${g.members} miembros)</option>`;
        });
        if (prevVal) select.value = prevVal;

        // Auto-select if only one guild
        if (!currentGuild && allGuilds.length === 1) {
          select.value = allGuilds[0].id;
          onGuildSelect();
        }

        loadAnnouncementsOverview();
      } catch (err) { console.error('Error loading dashboard:', err); }
    }

    // â”€â”€â”€ Guild Selection â”€â”€â”€
    async function onGuildSelect() {
      const id = document.getElementById('guild-select').value;
      if (!id) { currentGuild = null; currentGuildData = null; return; }
      currentGuild = id;
      try {
        const res = await fetch(`${API}/api/guilds/${id}`);
        currentGuildData = await res.json();
      } catch { currentGuildData = null; }
      // Refresh current page if it's a server-dependent page
      const activePage = document.querySelector('.page.active');
      if (activePage) {
        const pageId = activePage.id.replace('page-', '');
        if (['server-info', 'announcements', 'messages', 'warnings-page', 'verification', 'setup-wizard'].includes(pageId)) {
          showPage(pageId);
        }
      }
    }

    // â”€â”€â”€ Server Info Page â”€â”€â”€
    function renderServerInfo() {
      const el = document.getElementById('server-info-content');
      if (!currentGuild || !currentGuildData) { el.innerHTML = noServerHtml('ver su informaciÃ³n'); return; }
      const g = currentGuildData;

      // Group channels
      const categories = {};
      g.channels.forEach(c => { if (c.type === 4) categories[c.id] = { name: c.name, channels: [] }; });
      g.channels.forEach(c => { if (c.type !== 4) { if (c.parent && categories[c.parent]) categories[c.parent].channels.push(c); } });

      const typeIcons = { 0: '#', 2: 'ğŸ”Š', 5: 'ğŸ“¢', 15: 'ğŸ’¬' };
      let channelHtml = '';
      for (const [, cat] of Object.entries(categories)) {
        channelHtml += `<div class="channel-category"><div class="channel-category-name">ğŸ“ ${cat.name}</div>`;
        cat.channels.forEach(c => { channelHtml += `<div class="channel-item">${typeIcons[c.type] || '#'} ${c.name}</div>`; });
        channelHtml += '</div>';
      }

      const rolesHtml = g.roles.filter(r => r.name !== '@everyone')
        .map(r => `<div style="padding:4px 0;font-size:14px"><span style="color:${r.color};font-weight:600">â— ${r.name}</span> <span style="color:var(--text-secondary);font-size:12px">(${r.members})</span></div>`).join('');

      el.innerHTML = `
        <div class="page-header"><h2>ğŸ  ${g.name}</h2><p>${g.members} miembros Â· ${g.channels.length} canales Â· ${g.roles.length} roles</p></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value">${g.members}</div><div class="stat-label">Miembros</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ’¬</div><div class="stat-value">${g.channels.filter(c=>c.type===0).length}</div><div class="stat-label">Canales de texto</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ”Š</div><div class="stat-value">${g.channels.filter(c=>c.type===2).length}</div><div class="stat-label">Canales de voz</div></div>
          <div class="stat-card"><div class="stat-icon">ğŸ­</div><div class="stat-value">${g.roles.length}</div><div class="stat-label">Roles</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="card"><h3>ğŸ’¬ Canales</h3><div class="channel-tree">${channelHtml || '<p style="color:var(--text-secondary)">Sin canales</p>'}</div></div>
          <div class="card"><h3>ğŸ­ Roles</h3>${rolesHtml || '<p style="color:var(--text-secondary)">Sin roles</p>'}</div>
        </div>`;
    }

    // â”€â”€â”€ Channel dropdown helper â”€â”€â”€
    function channelOptions(typeFilter) {
      if (!currentGuildData) return '<option value="">Sin servidor</option>';
      const channels = currentGuildData.channels.filter(c => {
        if (typeFilter === 'text') return c.type === 0 || c.type === 5;
        return true;
      });
      let html = '<option value="">Selecciona canal...</option>';
      channels.forEach(c => {
        const icon = c.type === 2 ? 'ğŸ”Š' : c.type === 5 ? 'ğŸ“¢' : '#';
        html += `<option value="${c.id}">${icon} ${c.name}</option>`;
      });
      return html;
    }

    // â”€â”€â”€ Announcements Page â”€â”€â”€
    async function renderAnnouncements() {
      const el = document.getElementById('announcements-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('gestionar anuncios'); return; }

      el.innerHTML = `
        <div class="page-header"><h2>ğŸ“¢ Anuncios â€” ${currentGuildData?.name || ''}</h2><p>Crea y gestiona anuncios programados para este servidor</p></div>
        <div class="card">
          <h3>â• Nuevo Anuncio Programado</h3>
          <div class="form-grid">
            <div class="form-group"><label>Canal</label><select id="ann-channel">${channelOptions('text')}</select></div>
            <div class="form-group"><label>Frecuencia</label>
              <select id="ann-cron">
                <option value="0 * * * *">Cada hora</option><option value="0 */6 * * *">Cada 6 horas</option>
                <option value="0 8 * * *">Diario (8 AM)</option><option value="0 12 * * *">Diario (12 PM)</option>
                <option value="0 20 * * *">Diario (8 PM)</option><option value="0 9 * * 1-5">Lun-Vie (9 AM)</option>
                <option value="0 9 * * 1">Semanal (Lunes)</option><option value="0 9 1 * *">Mensual (dÃ­a 1)</option>
              </select>
            </div>
            <div class="form-group"><label>TÃ­tulo</label><input type="text" id="ann-title" placeholder="TÃ­tulo del anuncio"></div>
            <div class="form-group"><label>Color</label><input type="color" id="ann-color" value="#6c5ce7"></div>
          </div>
          <div class="form-group"><label>Mensaje</label><textarea id="ann-message" placeholder="Contenido del anuncio..."></textarea></div>
          <div class="form-actions"><button class="btn btn-primary" onclick="createAnnouncement()">Crear Anuncio</button></div>
        </div>
        <div class="card"><h3>ğŸ“‹ Anuncios Activos</h3>
          <table><thead><tr><th>ID</th><th>TÃ­tulo</th><th>Canal</th><th>Frecuencia</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody id="announcements-table"></tbody></table>
        </div>`;

      const res = await fetch(`${API}/api/announcements`);
      const data = await res.json();
      // Filter by guild channels
      const guildChannelIds = currentGuildData ? currentGuildData.channels.map(c => c.id) : [];
      const filtered = {};
      for (const [id, a] of Object.entries(data)) {
        if (a.guildId === currentGuild || guildChannelIds.includes(a.channelId)) filtered[id] = a;
      }
      renderAnnouncementsTable(filtered, 'announcements-table');
    }

    function renderAnnouncementsTable(data, tableId) {
      const tbody = document.getElementById(tableId);
      if (!tbody) return;
      const entries = Object.entries(data);
      if (!entries.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary)">No hay anuncios programados</td></tr>'; return; }
      const channelName = (id) => { if (!currentGuildData) return id?.slice(-6) || '-'; const ch = currentGuildData.channels.find(c => c.id === id); return ch ? `#${ch.name}` : id?.slice(-6) || '-'; };
      tbody.innerHTML = entries.map(([id, a]) => `<tr>
        <td><code style="color:var(--accent-light)">${id}</code></td>
        <td>${a.title || '-'}</td>
        <td>${channelName(a.channelId)}</td>
        <td><code style="font-size:12px">${a.cron || '-'}</code></td>
        <td><span class="badge ${a.active ? 'badge-green' : 'badge-red'}">${a.active ? 'Activo' : 'Pausado'}</span></td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteAnnouncement('${id}')">ğŸ—‘ï¸</button></td>
      </tr>`).join('');
    }

    async function loadAnnouncementsOverview() {
      const res = await fetch(`${API}/api/announcements`);
      const data = await res.json();
      renderAnnouncementsTable(data, 'overview-announcements');
    }

    async function createAnnouncement() {
      const body = {
        channelId: document.getElementById('ann-channel').value,
        title: document.getElementById('ann-title').value,
        message: document.getElementById('ann-message').value,
        cron: document.getElementById('ann-cron').value,
        color: document.getElementById('ann-color').value,
        guildId: currentGuild,
        active: true,
      };
      if (!body.channelId || !body.message) return toast('Selecciona canal y escribe un mensaje', true);
      const res = await fetch(`${API}/api/announcements`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (res.ok) { toast('âœ… Anuncio creado'); renderAnnouncements(); }
    }

    async function deleteAnnouncement(id) {
      if (!confirm('Â¿Eliminar este anuncio?')) return;
      await fetch(`${API}/api/announcements/${id}`, { method: 'DELETE' });
      toast('ğŸ—‘ï¸ Anuncio eliminado');
      renderAnnouncements();
      loadAnnouncementsOverview();
    }

    // â”€â”€â”€ Messages Page â”€â”€â”€
    function renderMessages() {
      const el = document.getElementById('messages-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('enviar mensajes'); return; }

      el.innerHTML = `
        <div class="page-header"><h2>ğŸ’¬ Enviar Mensaje â€” ${currentGuildData?.name || ''}</h2><p>EnvÃ­a un mensaje como el bot a un canal de este servidor</p></div>
        <div class="card">
          <h3>ğŸ’¬ Nuevo Mensaje</h3>
          <div class="form-group"><label>Canal</label><select id="msg-channel">${channelOptions('text')}</select></div>
          <div class="form-group"><label>Contenido (texto plano)</label><textarea id="msg-content" placeholder="Mensaje de texto..."></textarea></div>
          <h4 style="margin:16px 0 12px;font-size:14px;color:var(--text-secondary)">O enviar como Embed:</h4>
          <div class="form-grid">
            <div class="form-group"><label>TÃ­tulo del embed</label><input type="text" id="msg-embed-title" placeholder="TÃ­tulo"></div>
            <div class="form-group"><label>Color</label><input type="color" id="msg-embed-color" value="#6c5ce7"></div>
          </div>
          <div class="form-group"><label>DescripciÃ³n del embed</label><textarea id="msg-embed-desc" placeholder="Contenido del embed..."></textarea></div>
          <div class="form-group"><label>Footer</label><input type="text" id="msg-embed-footer" placeholder="Texto del footer"></div>
          <div class="form-actions"><button class="btn btn-primary" onclick="sendMessage()">Enviar</button></div>
        </div>`;
    }

    async function sendMessage() {
      const channelId = document.getElementById('msg-channel').value;
      const content = document.getElementById('msg-content').value;
      const embedTitle = document.getElementById('msg-embed-title').value;
      const embedDesc = document.getElementById('msg-embed-desc').value;
      const embedColor = document.getElementById('msg-embed-color').value;
      const embedFooter = document.getElementById('msg-embed-footer').value;
      if (!channelId) return toast('Selecciona un canal', true);
      if (!content && !embedDesc) return toast('Escribe un mensaje o embed', true);
      const body = { channelId };
      if (content) body.content = content;
      if (embedTitle || embedDesc) {
        body.embed = {};
        if (embedTitle) body.embed.title = embedTitle;
        if (embedDesc) body.embed.description = embedDesc;
        if (embedColor) body.embed.color = embedColor;
        if (embedFooter) body.embed.footer = embedFooter;
      }
      const res = await fetch(`${API}/api/send-message`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (res.ok) {
        toast('âœ… Mensaje enviado');
        document.getElementById('msg-content').value = '';
        document.getElementById('msg-embed-title').value = '';
        document.getElementById('msg-embed-desc').value = '';
      } else { const err = await res.json(); toast(`âŒ ${err.error}`, true); }
    }

    // â”€â”€â”€ Warnings Page â”€â”€â”€
    async function renderWarnings() {
      const el = document.getElementById('warnings-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('ver advertencias'); return; }

      el.innerHTML = `
        <div class="page-header"><h2>âš ï¸ Advertencias â€” ${currentGuildData?.name || ''}</h2><p>Historial de advertencias de moderaciÃ³n de este servidor</p></div>
        <div class="card"><table><thead><tr><th>Usuario ID</th><th>RazÃ³n</th><th>Moderador</th><th>Fecha</th></tr></thead>
        <tbody id="warnings-table"></tbody></table></div>`;

      const res = await fetch(`${API}/api/warnings`);
      const data = await res.json();
      const tbody = document.getElementById('warnings-table');
      const rows = [];
      for (const [key, list] of Object.entries(data)) {
        const parts = key.split('-');
        const guildId = parts[0];
        const userId = parts[1] || key;
        if (guildId !== currentGuild) continue;
        for (const w of list) {
          rows.push(`<tr><td><code>${userId}</code></td><td>${w.reason}</td><td>${w.mod || '-'}</td><td>${w.date ? new Date(w.date).toLocaleDateString() : '-'}</td></tr>`);
        }
      }
      tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">Sin advertencias en este servidor</td></tr>';
    }

    // â”€â”€â”€ Verification Page â”€â”€â”€
    async function renderVerification() {
      const el = document.getElementById('verification-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('ver la verificaciÃ³n'); return; }

      el.innerHTML = '<div class="page-header"><h2>ğŸ” VerificaciÃ³n</h2><p>Cargando configuraciÃ³n...</p></div>';

      try {
        const res = await fetch(`${API}/api/settings/${currentGuild}`);
        const data = await res.json();
        const v = data.verify || {};

        const typeNames = { puzzle: 'ğŸ§© Puzzle â€” Resolver acertijo', colors: 'ğŸ¨ Colores â€” Secuencia de emojis', math: 'ğŸ”¢ MatemÃ¡ticas â€” Resolver operaciÃ³n', question: 'ğŸ“ Pregunta â€” Respuesta libre' };

        if (v.channelId) {
          const channelName = currentGuildData?.channels.find(c => c.id === v.channelId)?.name || v.channelId;
          const roleName = currentGuildData?.roles.find(r => r.id === v.roleId)?.name || v.roleId;

          el.innerHTML = `
            <div class="page-header"><h2>ğŸ” VerificaciÃ³n â€” ${currentGuildData?.name || ''}</h2><p>Sistema de verificaciÃ³n creativa configurado</p></div>
            <div class="card">
              <h3>âœ… VerificaciÃ³n Activa</h3>
              <div class="config-item"><span class="config-label">Canal</span><span class="config-value">#${channelName}</span></div>
              <div class="config-item"><span class="config-label">Rol asignado</span><span class="config-value">@${roleName}</span></div>
              <div class="config-item"><span class="config-label">Tipo de desafÃ­o</span><span class="config-value">${typeNames[v.type] || v.type}</span></div>
            </div>
            <div class="info-box">
              <strong>Para cambiar la configuraciÃ³n</strong> usa el comando <code>/setupverify</code> en Discord.<br>
              Opciones: canal, rol a dar, y tipo de verificaciÃ³n (puzzle, colores, matemÃ¡ticas, pregunta).
            </div>`;
        } else {
          el.innerHTML = `
            <div class="page-header"><h2>ğŸ” VerificaciÃ³n â€” ${currentGuildData?.name || ''}</h2><p>Sistema de verificaciÃ³n creativa</p></div>
            <div class="card" style="text-align:center;padding:40px">
              <div style="font-size:48px;margin-bottom:16px">ğŸ”</div>
              <h3 style="justify-content:center">VerificaciÃ³n no configurada</h3>
              <p style="color:var(--text-secondary);margin-top:8px">Usa el comando <code>/setupverify</code> en Discord para activarla.</p>
              <div class="info-box" style="text-align:left;margin-top:20px">
                <strong>CÃ³mo configurar:</strong><br><br>
                <code>/setupverify canal:#verificaciÃ³n rol:@Verificado tipo:Puzzle</code><br><br>
                <strong>Tipos disponibles:</strong><br>
                ğŸ§© <strong>Puzzle</strong> â€” Resolver un acertijo en espaÃ±ol<br>
                ğŸ¨ <strong>Colores</strong> â€” Memorizar secuencia de emojis<br>
                ğŸ”¢ <strong>MatemÃ¡ticas</strong> â€” Resolver operaciÃ³n aritmÃ©tica<br>
                ğŸ“ <strong>Pregunta</strong> â€” Responder con al menos 10 palabras
              </div>
            </div>`;
        }
      } catch {
        el.innerHTML = noServerHtml('ver la verificaciÃ³n');
      }
    }

    // â”€â”€â”€ Setup Wizard â”€â”€â”€
    let wizardStep = 1;
    let wizardTemplates = null;
    let wizardData = { templateKey: null, categories: [], roles: [], deleteExisting: false, enableVerification: false, verifyType: 'puzzle' };

    async function renderSetupWizard() {
      const el = document.getElementById('setup-wizard-content');
      if (!currentGuild) { el.innerHTML = noServerHtml('personalizar el servidor'); return; }

      // Load templates on first render
      if (!wizardTemplates) {
        try {
          const res = await fetch(`${API}/api/setup-templates`);
          wizardTemplates = await res.json();
        } catch { el.innerHTML = '<div class="card"><p style="color:var(--red)">Error cargando plantillas</p></div>'; return; }
      }

      const stepLabels = ['Plantilla', 'Canales', 'Roles', 'Opciones', 'Ejecutar'];
      const stepsHtml = stepLabels.map((label, i) => {
        const n = i + 1;
        const cls = n === wizardStep ? 'active' : n < wizardStep ? 'done' : '';
        return `<div class="wizard-step ${cls}">${n}. ${label}</div>`;
      }).join('');

      let content = '';
      if (wizardStep === 1) content = renderWizardStep1();
      else if (wizardStep === 2) content = renderWizardStep2();
      else if (wizardStep === 3) content = renderWizardStep3();
      else if (wizardStep === 4) content = renderWizardStep4();
      else if (wizardStep === 5) content = renderWizardStep5();

      el.innerHTML = `
        <div class="page-header"><h2>ğŸ› ï¸ Personalizar Servidor â€” ${currentGuildData?.name || ''}</h2><p>Configura la estructura de tu servidor paso a paso</p></div>
        <div class="wizard-steps">${stepsHtml}</div>
        ${content}`;
    }

    function renderWizardStep1() {
      const icons = { gaming: 'ğŸ®', community: 'ğŸŒ', business: 'ğŸ’¼' };
      let cards = '';
      for (const [key, tpl] of Object.entries(wizardTemplates)) {
        const selected = wizardData.templateKey === key ? 'selected' : '';
        cards += `<div class="template-card ${selected}" onclick="selectTemplate('${key}')">
          <div class="tpl-icon">${icons[key] || 'ğŸ“¦'}</div>
          <div class="tpl-name">${tpl.name}</div>
          <div class="tpl-stats">${tpl.totalCategories} categorias Â· ${tpl.totalChannels} canales Â· ${tpl.totalRoles} roles</div>
        </div>`;
      }
      return `<div class="template-cards">${cards}</div>
        <div class="wizard-nav"><div></div><button class="btn btn-primary" onclick="wizardNext()" ${!wizardData.templateKey ? 'disabled style="opacity:0.5"' : ''}>Siguiente â†’</button></div>`;
    }

    function selectTemplate(key) {
      wizardData.templateKey = key;
      const tpl = wizardTemplates[key];
      wizardData.categories = JSON.parse(JSON.stringify(tpl.categories.map(cat => ({ ...cat, enabled: true, channels: cat.channels.map(ch => ({ ...ch, enabled: true })) }))));
      wizardData.roles = JSON.parse(JSON.stringify(tpl.roles.map(r => ({ ...r, enabled: true }))));
      renderSetupWizard();
    }

    function renderWizardStep2() {
      if (!wizardData.categories.length) return '<p>Selecciona una plantilla primero</p>';
      let html = '';
      wizardData.categories.forEach((cat, ci) => {
        let channels = '';
        cat.channels.forEach((ch, chi) => {
          const icon = ch.type === 'voice' ? 'ğŸ”Š' : ch.type === 'announcement' ? 'ğŸ“¢' : '#';
          channels += `<div class="toggle-row">
            <label><input type="checkbox" ${ch.enabled ? 'checked' : ''} onchange="wizardData.categories[${ci}].channels[${chi}].enabled=this.checked"> ${icon} ${ch.name}</label>
            <input type="text" value="${ch.name}" onchange="wizardData.categories[${ci}].channels[${chi}].name=this.value" placeholder="Nombre">
          </div>`;
        });
        html += `<div class="category-block">
          <div class="category-header"><input type="checkbox" ${cat.enabled ? 'checked' : ''} onchange="wizardData.categories[${ci}].enabled=this.checked;renderSetupWizard()"> ${cat.name}</div>
          ${cat.enabled ? channels : '<div style="padding:8px 12px;color:var(--text-secondary);font-size:13px">Categoria desactivada</div>'}
        </div>`;
      });
      return `<div class="card">${html}</div>
        <div class="wizard-nav"><button class="btn btn-ghost" onclick="wizardPrev()">â† Anterior</button><button class="btn btn-primary" onclick="wizardNext()">Siguiente â†’</button></div>`;
    }

    function renderWizardStep3() {
      if (!wizardData.roles.length) return '<p>Selecciona una plantilla primero</p>';
      let html = '';
      wizardData.roles.forEach((r, ri) => {
        const color = typeof r.color === 'number' ? '#' + r.color.toString(16).padStart(6, '0') : r.color;
        html += `<div class="toggle-row">
          <label><input type="checkbox" ${r.enabled ? 'checked' : ''} onchange="wizardData.roles[${ri}].enabled=this.checked"> <span class="role-color-dot" style="background:${color}"></span> ${r.name}</label>
          <input type="text" value="${r.name}" onchange="wizardData.roles[${ri}].name=this.value" placeholder="Nombre del rol">
        </div>`;
      });
      return `<div class="card"><h3>ğŸ­ Roles</h3>${html}</div>
        <div class="wizard-nav"><button class="btn btn-ghost" onclick="wizardPrev()">â† Anterior</button><button class="btn btn-primary" onclick="wizardNext()">Siguiente â†’</button></div>`;
    }

    function renderWizardStep4() {
      return `
        <div class="card">
          <h3>âš™ï¸ Opciones adicionales</h3>
          <div class="toggle-row">
            <label><input type="checkbox" ${wizardData.deleteExisting ? 'checked' : ''} onchange="wizardData.deleteExisting=this.checked;renderSetupWizard()"> Borrar canales existentes antes de crear</label>
          </div>
          ${wizardData.deleteExisting ? '<div class="warning-box">âš ï¸ <strong>Cuidado:</strong> Esto eliminara TODOS los canales y categorias actuales del servidor. Esta accion es irreversible.</div>' : ''}
          <div class="toggle-row" style="margin-top:12px">
            <label><input type="checkbox" ${wizardData.enableVerification ? 'checked' : ''} onchange="wizardData.enableVerification=this.checked;renderSetupWizard()"> Activar sistema de verificacion</label>
          </div>
          ${wizardData.enableVerification ? `
            <div style="padding:12px;margin-top:8px">
              <div class="form-group">
                <label>Tipo de verificacion</label>
                <select onchange="wizardData.verifyType=this.value" style="width:100%;padding:10px 14px;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:14px">
                  <option value="puzzle" ${wizardData.verifyType==='puzzle'?'selected':''}>ğŸ§© Puzzle â€” Resolver acertijo</option>
                  <option value="colors" ${wizardData.verifyType==='colors'?'selected':''}>ğŸ¨ Colores â€” Secuencia de emojis</option>
                  <option value="math" ${wizardData.verifyType==='math'?'selected':''}>ğŸ”¢ Matematicas â€” Resolver operacion</option>
                  <option value="question" ${wizardData.verifyType==='question'?'selected':''}>ğŸ“ Pregunta â€” Respuesta libre</option>
                </select>
              </div>
            </div>` : ''}
        </div>
        <div class="wizard-nav"><button class="btn btn-ghost" onclick="wizardPrev()">â† Anterior</button><button class="btn btn-primary" onclick="wizardNext()">Revisar â†’</button></div>`;
    }

    function renderWizardStep5() {
      const tpl = wizardTemplates[wizardData.templateKey];
      const enabledCats = wizardData.categories.filter(c => c.enabled);
      const enabledChannels = enabledCats.reduce((acc, c) => acc + c.channels.filter(ch => ch.enabled).length, 0);
      const enabledRoles = wizardData.roles.filter(r => r.enabled);

      let catsList = enabledCats.map(c => {
        const chs = c.channels.filter(ch => ch.enabled).map(ch => `<li>${ch.type === 'voice' ? 'ğŸ”Š' : '#'} ${ch.name}</li>`).join('');
        return `<li><strong>${c.name}</strong><ul>${chs}</ul></li>`;
      }).join('');

      let rolesList = enabledRoles.map(r => {
        const color = typeof r.color === 'number' ? '#' + r.color.toString(16).padStart(6, '0') : r.color;
        return `<li><span class="role-color-dot" style="background:${color}"></span> ${r.name}</li>`;
      }).join('');

      return `
        <div class="card">
          <h3>ğŸ“‹ Resumen</h3>
          <div class="info-box">Plantilla: <strong>${tpl.name}</strong> Â· ${enabledCats.length} categorias Â· ${enabledChannels} canales Â· ${enabledRoles.length} roles
            ${wizardData.deleteExisting ? ' Â· <span style="color:var(--yellow)">Borrar existentes</span>' : ''}
            ${wizardData.enableVerification ? ` Â· Verificacion (${wizardData.verifyType})` : ''}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div class="review-section"><h4>ğŸ“ Categorias y Canales</h4><ul class="review-list">${catsList}</ul></div>
            <div class="review-section"><h4>ğŸ­ Roles</h4><ul class="review-list">${rolesList}</ul></div>
          </div>
        </div>
        <div id="wizard-progress" style="display:none">
          <div class="card">
            <h3>âš™ï¸ Creando servidor...</h3>
            <div class="progress-log" id="wizard-log"></div>
          </div>
        </div>
        <div class="wizard-nav" id="wizard-exec-nav">
          <button class="btn btn-ghost" onclick="wizardPrev()">â† Anterior</button>
          <button class="btn btn-primary" onclick="executeWizard()" id="wizard-exec-btn">ğŸš€ Crear Servidor</button>
        </div>`;
    }

    function wizardNext() {
      if (wizardStep === 1 && !wizardData.templateKey) return;
      if (wizardStep < 5) { wizardStep++; renderSetupWizard(); }
    }
    function wizardPrev() {
      if (wizardStep > 1) { wizardStep--; renderSetupWizard(); }
    }

    async function executeWizard() {
      const btn = document.getElementById('wizard-exec-btn');
      btn.disabled = true;
      btn.textContent = 'Creando...';
      document.getElementById('wizard-progress').style.display = 'block';
      document.getElementById('wizard-exec-nav').style.display = 'none';
      const log = document.getElementById('wizard-log');

      const addLog = (msg, cls) => {
        const line = document.createElement('div');
        line.className = 'log-line' + (cls ? ` ${cls}` : '');
        line.textContent = msg;
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
      };

      addLog('Iniciando setup del servidor...');

      try {
        const body = {
          guildId: currentGuild,
          templateKey: wizardData.templateKey,
          deleteExisting: wizardData.deleteExisting,
          categories: wizardData.categories.filter(c => c.enabled).map(c => ({
            ...c, channels: c.channels.filter(ch => ch.enabled)
          })),
          roles: wizardData.roles.filter(r => r.enabled),
          enableVerification: wizardData.enableVerification,
          verifyType: wizardData.verifyType,
        };

        const res = await fetch(`${API}/api/setup-server`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            try {
              const data = JSON.parse(line.slice(6));
              if (data.type === 'progress') addLog(data.message);
              else if (data.type === 'complete') { addLog(data.message, 'success'); addLog('--- Setup completado ---', 'success'); }
              else if (data.type === 'error') addLog('ERROR: ' + data.message, 'error');
            } catch {}
          }
        }

        // Refresh guild data
        try {
          const gRes = await fetch(`${API}/api/guilds/${currentGuild}`);
          currentGuildData = await gRes.json();
        } catch {}

        // Show restart button
        const nav = document.getElementById('wizard-exec-nav');
        nav.style.display = 'flex';
        nav.innerHTML = '<button class="btn btn-ghost" onclick="wizardStep=1;wizardData={templateKey:null,categories:[],roles:[],deleteExisting:false,enableVerification:false,verifyType:\'puzzle\'};renderSetupWizard()">ğŸ”„ Nuevo Setup</button><button class="btn btn-primary" onclick="showPage(\'server-info\')">Ver Servidor â†’</button>';
      } catch (err) {
        addLog('Error de conexion: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'ğŸš€ Reintentar';
        document.getElementById('wizard-exec-nav').style.display = 'flex';
      }
    }

    // â”€â”€â”€ Toast â”€â”€â”€
    function toast(msg, isError) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      if (isError) el.style.borderColor = 'var(--red)';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // â”€â”€â”€ Auto-refresh â”€â”€â”€
    setInterval(() => {
      if (document.getElementById('app').style.display !== 'none') loadDashboard();
    }, 30000);

    checkAuth();
  </script>
</body>
</html>
